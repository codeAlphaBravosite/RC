<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>CUET RC Master â€” Score 200/200</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@300;400;500;600;700&family=Noto+Serif:wght@400;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script>
tailwind.config = {
  theme: {
    extend: {
      fontFamily: { sans: ['Noto Sans','sans-serif'], serif: ['Noto Serif','serif'], mono: ['JetBrains Mono','monospace'] },
      colors: {
        nta: { blue: '#1a3c8c', light: '#3b60c4', pale: '#e8eef9', dark: '#0f2460' },
        exam: { green: '#2d7a2d', orange: '#e07b00', purple: '#6b2fa0', red: '#cc2222', gray: '#888' }
      }
    }
  }
};
</script>
<style>
body { background: #f0f4f8; font-family: 'Noto Sans', sans-serif; -webkit-font-smoothing: antialiased; margin: 0; }
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: #e2e8f0; }
::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
.q-not-visited { background: #d1d5db; border: 1.5px solid #9ca3af; color: #374151; }
.q-answered { background: #16a34a; border: 1.5px solid #15803d; color: white; }
.q-not-answered { background: #dc2626; border: 1.5px solid #b91c1c; color: white; }
.q-marked { background: #7c3aed; border: 1.5px solid #6d28d9; color: white; }
.q-answered-marked { background: #7c3aed; border: 1.5px solid #6d28d9; color: white; position: relative; }
.q-answered-marked::after { content: 'âœ“'; position: absolute; bottom: -1px; right: 1px; font-size: 8px; color: #86efac; }
.q-current-ring { box-shadow: 0 0 0 3px #1a3c8c, 0 0 0 5px #93c5fd; }
.option-radio { accent-color: #1a3c8c; width: 16px; height: 16px; cursor: pointer; }
.option-correct { background: #dcfce7 !important; border-color: #16a34a !important; }
.option-wrong { background: #fee2e2 !important; border-color: #dc2626 !important; }
.option-show-correct { background: #dcfce7 !important; border-color: #16a34a !important; }
.passage-highlight { background: linear-gradient(120deg, #fef9c3 0%, #fef3c7 100%); border-radius: 2px; padding: 0 2px; }
.trap-badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; }
@keyframes pulse-border { 0%,100%{box-shadow:0 0 0 0 rgba(26,60,140,0.4)} 50%{box-shadow:0 0 0 6px rgba(26,60,140,0)} }
.timer-warning { animation: pulse-border 1s infinite; }
@keyframes slideIn { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:translateY(0)} }
.slide-in { animation: slideIn 0.3s ease forwards; }
@keyframes fadeIn { from{opacity:0} to{opacity:1} }
.fade-in { animation: fadeIn 0.4s ease forwards; }
.nta-header { background: linear-gradient(135deg, #1a3c8c 0%, #0f2460 100%); }
.legend-dot { width: 14px; height: 14px; border-radius: 3px; display: inline-block; flex-shrink: 0; }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;

// â”€â”€â”€ CONSTANTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const API_KEY_STORAGE = 'cuet_rc_api_key';
const STATS_STORAGE   = 'cuet_rc_stats_v3';
const GEMINI_URL = key => `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`;

const PASSAGE_TYPES = ['Scientific/Factual','Literary/Narrative','Philosophical/Abstract','Social/Current Affairs','Environmental','Historical/Cultural','Psychological'];
const DIFFICULTY_LEVELS = ['Easy','Medium','Hard','CUET Expert'];
const Q_TYPES = ['Factual Retrieval','Tone / Attitude','Inference','Title / Central Theme','Vocabulary in Context','Main Idea of Paragraph',"Author's Purpose"];
const TRAPS = ['Extreme Language','True but Not in Passage','Partially Correct','Too Narrow for Title','Opposite Tone','Synonym Substitution','Attractive Distractor'];

// â”€â”€â”€ GEMINI SERVICE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function generateRCPassage(apiKey, passageType, difficulty, weakQTypes = []) {
  const focusNote = weakQTypes.length > 0
    ? `IMPORTANT: Include extra questions of these types since the student is weak at them: ${weakQTypes.join(', ')}.`
    : '';

  const prompt = `You are an expert NTA (National Testing Agency) CUET English paper setter who has set CUET papers from 2022-2025.

Generate a CUET-style Reading Comprehension passage and exactly 6 questions.

SPECIFICATIONS:
- Passage Type: ${passageType}
- Difficulty: ${difficulty}
- Passage Length: 280-380 words
- Style: Exactly like real CUET passages â€” academic, sophisticated vocabulary, suitable for 12th grade
${focusNote}

QUESTION TYPES TO INCLUDE (pick 6 from these, vary them):
- Factual Retrieval: Direct answer in passage
- Tone / Attitude: Author's tone or attitude
- Inference: Implied meaning NOT directly stated
- Title / Central Theme: What title best suits the passage
- Vocabulary in Context: Word/phrase meaning in context
- Main Idea of Paragraph: What a specific paragraph is about
- Author's Purpose: Why the author wrote this

STRICT RULES FOR QUESTIONS (exactly how NTA sets them):
- Correct answer must be unambiguously correct
- Wrong options must be plausible but clearly incorrect on careful analysis
- Include at least 2 trap options (extreme language / true-but-not-in-passage / partially correct)
- For Inference questions: correct answer must never go "beyond" what the text implies
- For Title questions: wrong options must be either too narrow or too broad
- Explanation must teach the STRATEGY, not just state the answer

Respond ONLY with valid JSON â€” no markdown, no extra text:
{
  "passageType": "${passageType}",
  "difficulty": "${difficulty}",
  "title": "Short descriptive title of the passage",
  "passage": "Full passage text here. Use \\n\\n to separate paragraphs.",
  "questions": [
    {
      "qType": "one of the question types above",
      "question": "Question text exactly as it would appear in CUET exam",
      "options": ["Option A text", "Option B text", "Option C text", "Option D text"],
      "correctIndex": 0,
      "trapType": "which trap does this question use (or 'None')",
      "hint": "One sentence strategy hint â€” tell WHERE in passage to look and HOW to decide",
      "explanation": "2-3 sentence expert explanation: Why correct answer is right + Why each wrong option is wrong + What strategy to use",
      "keyLine": "Exact phrase from passage that proves the answer (for factual/inference questions)"
    }
  ]
}`;

  const res = await fetch(GEMINI_URL(apiKey.trim()), {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      contents: [{ role: 'user', parts: [{ text: prompt }] }],
      generationConfig: { responseMimeType: 'application/json', temperature: 0.8, maxOutputTokens: 4000 }
    })
  });

  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    const msg = err?.error?.message || `HTTP ${res.status}`;
    if (res.status === 400) throw new Error('Invalid API key. Check your Gemini API key in Settings.');
    if (res.status === 429) throw new Error('Rate limit hit. Wait a moment and try again.');
    throw new Error(`Gemini API error: ${msg}`);
  }

  const data = await res.json();
  const text = data?.candidates?.[0]?.content?.parts?.[0]?.text;
  if (!text) throw new Error('Empty response from Gemini. Try again.');

  const parsed = JSON.parse(text.replace(/```json|```/g, '').trim());
  return parsed;
}

// â”€â”€â”€ STATS ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadStats() {
  try {
    const raw = localStorage.getItem(STATS_STORAGE);
    if (raw) return JSON.parse(raw);
  } catch(e) {}
  return { totalAttempted: 0, totalCorrect: 0, byQType: {}, byPassageType: {}, sessions: [], streak: 0, lastDate: null };
}

function saveStats(stats) {
  try { localStorage.setItem(STATS_STORAGE, JSON.stringify(stats)); } catch(e) {}
}

function updateStats(stats, results) {
  const today = new Date().toISOString().split('T')[0];
  const newStats = { ...stats };
  newStats.totalAttempted += results.length;
  newStats.totalCorrect += results.filter(r => r.correct).length;
  results.forEach(r => {
    if (!newStats.byQType[r.qType]) newStats.byQType[r.qType] = { correct: 0, total: 0 };
    newStats.byQType[r.qType].total++;
    if (r.correct) newStats.byQType[r.qType].correct++;
    if (!newStats.byPassageType[r.passageType]) newStats.byPassageType[r.passageType] = { correct: 0, total: 0 };
    newStats.byPassageType[r.passageType].total++;
    if (r.correct) newStats.byPassageType[r.passageType].correct++;
  });
  newStats.sessions = [...(newStats.sessions || []).slice(-29), { date: today, correct: results.filter(r=>r.correct).length, total: results.length }];
  if (newStats.lastDate === today) { /* same day - no streak change */ }
  else if (newStats.lastDate === new Date(Date.now()-86400000).toISOString().split('T')[0]) { newStats.streak = (newStats.streak||0)+1; }
  else { newStats.streak = 1; }
  newStats.lastDate = today;
  return newStats;
}

function getWeakQTypes(stats) {
  return Object.entries(stats.byQType)
    .filter(([, v]) => v.total >= 3 && (v.correct/v.total) < 0.7)
    .map(([k]) => k)
    .slice(0,3);
}

// â”€â”€â”€ TIMER HOOK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function useTimer(seconds, running) {
  const [left, setLeft] = useState(seconds);
  const ref = useRef(null);
  useEffect(() => {
    setLeft(seconds);
  }, [seconds]);
  useEffect(() => {
    if (!running) { clearInterval(ref.current); return; }
    ref.current = setInterval(() => setLeft(l => Math.max(0, l-1)), 1000);
    return () => clearInterval(ref.current);
  }, [running]);
  const fmt = s => `${String(Math.floor(s/3600)).padStart(2,'0')}:${String(Math.floor((s%3600)/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
  return { left, formatted: fmt(left), pct: (left/seconds)*100 };
}

// â”€â”€â”€ SCREENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 1. SETUP / HOME
function SetupScreen({ apiKey, setApiKey, onStart, stats }) {
  const [localKey, setLocalKey] = useState(apiKey);
  const [showKey, setShowKey] = useState(false);
  const [passageType, setPassageType] = useState('Random');
  const [difficulty, setDifficulty] = useState('Medium');
  const [examMode, setExamMode] = useState(false); // exam=timed+no hints, training=hints shown after
  const [saved, setSaved] = useState(false);
  const acc = stats.totalAttempted > 0 ? Math.round((stats.totalCorrect/stats.totalAttempted)*100) : null;
  const weakTypes = getWeakQTypes(stats);

  const handleSaveKey = () => {
    setApiKey(localKey.trim());
    try { localStorage.setItem(API_KEY_STORAGE, localKey.trim()); } catch(e) {}
    setSaved(true); setTimeout(() => setSaved(false), 1500);
  };

  const handleStart = () => {
    if (!localKey.trim()) { alert('Please enter your Gemini API key first.'); return; }
    const type = passageType === 'Random' ? PASSAGE_TYPES[Math.floor(Math.random()*PASSAGE_TYPES.length)] : passageType;
    onStart({ passageType: type, difficulty, examMode });
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-100 to-blue-50 flex flex-col">
      {/* NTA-style Header */}
      <div className="nta-header text-white py-3 px-6 flex items-center justify-between shadow-lg">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center font-bold text-lg font-serif">N</div>
          <div>
            <div className="font-bold text-sm tracking-wide">NATIONAL TESTING AGENCY</div>
            <div className="text-blue-200 text-xs">Common University Entrance Test (CUET) â€” English</div>
          </div>
        </div>
        <div className="text-right">
          <div className="text-xs text-blue-200">RC Mastery Trainer</div>
          <div className="text-white font-bold text-sm font-mono">v2.0 â€” AI Powered</div>
        </div>
      </div>

      <div className="flex-1 max-w-5xl mx-auto w-full p-4 md:p-6 grid md:grid-cols-3 gap-6">
        {/* Left â€” Config */}
        <div className="md:col-span-2 space-y-4">
          {/* Welcome card */}
          <div className="bg-white rounded-xl border border-blue-100 shadow-sm p-5">
            <div className="flex items-start gap-3">
              <div className="w-12 h-12 bg-nta-pale rounded-xl flex items-center justify-center text-2xl flex-shrink-0">ğŸ¯</div>
              <div>
                <h1 className="font-bold text-gray-900 text-lg">CUET RC Master Trainer</h1>
                <p className="text-gray-500 text-sm mt-1">AI-powered infinite Reading Comprehension practice. Exact NTA exam interface. Zero marks lost â€” trained like a topper.</p>
              </div>
            </div>
          </div>

          {/* API Key */}
          <div className="bg-white rounded-xl border border-blue-100 shadow-sm p-5">
            <div className="flex items-center gap-2 mb-3">
              <span className="text-lg">ğŸ”‘</span>
              <h3 className="font-semibold text-gray-800">Gemini API Key</h3>
              <span className="bg-green-100 text-green-700 text-xs px-2 py-0.5 rounded-full font-medium ml-auto">Free</span>
            </div>
            <div className="flex gap-2">
              <div className="relative flex-1">
                <input
                  type={showKey ? 'text' : 'password'}
                  value={localKey}
                  onChange={e => setLocalKey(e.target.value)}
                  onKeyDown={e => e.key === 'Enter' && handleSaveKey()}
                  placeholder="AIzaSy..."
                  className="w-full border border-gray-200 rounded-lg px-3 py-2.5 text-sm font-mono focus:outline-none focus:border-nta-blue focus:ring-1 focus:ring-blue-300 pr-10"
                />
                <button onClick={() => setShowKey(!showKey)} className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 text-xs">
                  {showKey ? 'ğŸ™ˆ' : 'ğŸ‘'}
                </button>
              </div>
              <button onClick={handleSaveKey} className={`px-4 py-2 rounded-lg text-sm font-semibold transition-all ${saved ? 'bg-green-500 text-white' : 'bg-nta-blue text-white hover:bg-nta-light'}`}>
                {saved ? 'âœ“ Saved' : 'Save'}
              </button>
            </div>
            {localKey && <div className="mt-2 flex items-center gap-1.5 text-xs text-green-600"><span className="w-2 h-2 rounded-full bg-green-500 inline-block animate-pulse"></span>Key active â€” AI passages enabled</div>}
            <p className="text-xs text-gray-400 mt-2">Get free key: <a href="https://aistudio.google.com/apikey" target="_blank" className="text-blue-600 underline">aistudio.google.com/apikey</a></p>
          </div>

          {/* Settings Grid */}
          <div className="bg-white rounded-xl border border-blue-100 shadow-sm p-5">
            <h3 className="font-semibold text-gray-800 mb-4 flex items-center gap-2"><span>âš™ï¸</span> Session Settings</h3>
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label className="block text-xs font-semibold text-gray-600 mb-2 uppercase tracking-wide">Passage Type</label>
                <select value={passageType} onChange={e => setPassageType(e.target.value)}
                  className="w-full border border-gray-200 rounded-lg px-3 py-2.5 text-sm focus:outline-none focus:border-nta-blue bg-gray-50">
                  <option>Random</option>
                  {PASSAGE_TYPES.map(t => <option key={t}>{t}</option>)}
                </select>
              </div>
              <div>
                <label className="block text-xs font-semibold text-gray-600 mb-2 uppercase tracking-wide">Difficulty Level</label>
                <select value={difficulty} onChange={e => setDifficulty(e.target.value)}
                  className="w-full border border-gray-200 rounded-lg px-3 py-2.5 text-sm focus:outline-none focus:border-nta-blue bg-gray-50">
                  {DIFFICULTY_LEVELS.map(d => <option key={d}>{d}</option>)}
                </select>
              </div>
            </div>

            {/* Mode Toggle */}
            <div className="mt-4 grid grid-cols-2 gap-3">
              <button onClick={() => setExamMode(false)}
                className={`p-3 rounded-xl border-2 text-left transition-all ${!examMode ? 'border-nta-blue bg-nta-pale' : 'border-gray-200 hover:border-gray-300'}`}>
                <div className="font-semibold text-sm text-gray-800">ğŸ“ Training Mode</div>
                <div className="text-xs text-gray-500 mt-0.5">Hints + explanations after each question. Learn as you go.</div>
              </button>
              <button onClick={() => setExamMode(true)}
                className={`p-3 rounded-xl border-2 text-left transition-all ${examMode ? 'border-red-500 bg-red-50' : 'border-gray-200 hover:border-gray-300'}`}>
                <div className="font-semibold text-sm text-gray-800">ğŸ† Exam Mode</div>
                <div className="text-xs text-gray-500 mt-0.5">Real CUET interface. Timer. No hints. Review after submit.</div>
              </button>
            </div>

            {weakTypes.length > 0 && (
              <div className="mt-3 p-3 bg-amber-50 border border-amber-200 rounded-lg">
                <div className="text-xs font-semibold text-amber-800 mb-1">âš ï¸ AI will target your weak areas:</div>
                <div className="flex flex-wrap gap-1">
                  {weakTypes.map(t => <span key={t} className="bg-amber-100 text-amber-800 text-xs px-2 py-0.5 rounded-full border border-amber-300">{t}</span>)}
                </div>
              </div>
            )}
          </div>

          <button onClick={handleStart} disabled={!localKey.trim()}
            className={`w-full py-4 rounded-xl font-bold text-lg transition-all shadow-lg ${localKey.trim() ? 'bg-nta-blue text-white hover:bg-nta-light hover:shadow-xl hover:-translate-y-0.5 transform' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}`}>
            {localKey.trim() ? 'â–¶  Generate Passage & Start' : 'ğŸ”‘ Enter API Key to Start'}
          </button>
        </div>

        {/* Right â€” Stats Panel */}
        <div className="space-y-4">
          {/* Quick Stats */}
          <div className="bg-white rounded-xl border border-blue-100 shadow-sm p-5">
            <h3 className="font-semibold text-gray-800 mb-3 flex items-center gap-2"><span>ğŸ“Š</span> Your Performance</h3>
            {stats.totalAttempted === 0 ? (
              <div className="text-center py-4 text-gray-400 text-sm">No attempts yet.<br/>Start your first session!</div>
            ) : (
              <div className="space-y-3">
                <div className="text-center p-3 bg-nta-pale rounded-xl">
                  <div className="text-3xl font-bold text-nta-blue">{acc}%</div>
                  <div className="text-xs text-gray-500 mt-0.5">Overall Accuracy</div>
                </div>
                <div className="grid grid-cols-2 gap-2">
                  <div className="bg-green-50 rounded-lg p-2 text-center border border-green-100">
                    <div className="font-bold text-green-700">{stats.totalCorrect}</div>
                    <div className="text-xs text-gray-500">Correct</div>
                  </div>
                  <div className="bg-red-50 rounded-lg p-2 text-center border border-red-100">
                    <div className="font-bold text-red-600">{stats.totalAttempted - stats.totalCorrect}</div>
                    <div className="text-xs text-gray-500">Wrong</div>
                  </div>
                </div>
                <div className="bg-purple-50 rounded-lg p-2 text-center border border-purple-100">
                  <div className="font-bold text-purple-700">ğŸ”¥ {stats.streak || 0} day streak</div>
                </div>
              </div>
            )}
          </div>

          {/* Question Type Accuracy */}
          {Object.keys(stats.byQType).length > 0 && (
            <div className="bg-white rounded-xl border border-blue-100 shadow-sm p-5">
              <h3 className="font-semibold text-gray-800 mb-3 text-sm">Question Type Accuracy</h3>
              <div className="space-y-2">
                {Object.entries(stats.byQType).map(([type, data]) => {
                  const pct = Math.round((data.correct/data.total)*100);
                  const color = pct >= 80 ? 'bg-green-500' : pct >= 60 ? 'bg-amber-500' : 'bg-red-500';
                  return (
                    <div key={type}>
                      <div className="flex justify-between text-xs mb-1">
                        <span className="text-gray-600 truncate pr-2">{type}</span>
                        <span className={`font-bold ${pct>=80?'text-green-600':pct>=60?'text-amber-600':'text-red-600'}`}>{pct}%</span>
                      </div>
                      <div className="h-1.5 bg-gray-100 rounded-full overflow-hidden">
                        <div className={`h-full ${color} rounded-full transition-all`} style={{width:`${pct}%`}}></div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          )}

          {/* Strategy Tips */}
          <div className="bg-gradient-to-br from-nta-blue to-nta-dark rounded-xl p-4 text-white">
            <div className="font-bold text-sm mb-2">ğŸ’¡ Expert Tip</div>
            <div className="text-blue-100 text-xs leading-relaxed">
              {weakTypes.length > 0
                ? `Focus: You're weakest at "${weakTypes[0]}". Today's passage will target it.`
                : 'Use the 3-Pass Method: Skim â†’ Read Questions â†’ Targeted Read. Never read fully before seeing questions.'}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

// 2. LOADING SCREEN
function LoadingScreen({ passageType, difficulty }) {
  const [step, setStep] = useState(0);
  const steps = ['Connecting to Gemini AI...', 'Crafting a CUET-style passage...', 'Setting expert questions...', 'Calibrating traps and distractors...', 'Preparing your exam...'];
  useEffect(() => {
    const t = setInterval(() => setStep(s => Math.min(s+1, steps.length-1)), 800);
    return () => clearInterval(t);
  }, []);
  return (
    <div className="min-h-screen bg-gradient-to-br from-nta-blue to-nta-dark flex flex-col items-center justify-center text-white p-6">
      <div className="text-5xl mb-6 animate-bounce">ğŸ§ </div>
      <h2 className="text-2xl font-bold mb-2">AI Generating Passage</h2>
      <p className="text-blue-300 text-sm mb-8">{passageType} Â· {difficulty}</p>
      <div className="w-64 h-2 bg-white/20 rounded-full overflow-hidden mb-6">
        <div className="h-full bg-white rounded-full transition-all duration-500" style={{width:`${((step+1)/steps.length)*100}%`}}></div>
      </div>
      <div className="space-y-2 w-72">
        {steps.map((s, i) => (
          <div key={i} className={`flex items-center gap-3 text-sm transition-all ${i <= step ? 'text-white' : 'text-white/30'}`}>
            <span className="text-lg">{i < step ? 'âœ…' : i === step ? 'â³' : 'â—‹'}</span>
            {s}
          </div>
        ))}
      </div>
    </div>
  );
}

// 3. MAIN EXAM SCREEN (NTA Interface Replica)
function ExamScreen({ passageData, examMode, stats, onFinish, onHome }) {
  const [currentQ, setCurrentQ] = useState(0);
  const [selections, setSelections] = useState({}); // qIdx -> optionIdx
  const [statuses, setStatuses] = useState({}); // 'answered','not-answered','marked','answered-marked','not-visited'
  const [submitted, setSubmitted] = useState(false);
  const [showHint, setShowHint] = useState(false);
  const [showExplanation, setShowExplanation] = useState({});
  const [showPassage, setShowPassage] = useState(true); // mobile toggle
  const timerSecs = examMode ? 8*60 : 999999; // 8 min in exam mode
  const { left, formatted, pct } = useTimer(timerSecs, !submitted);

  // Auto-submit when timer ends
  useEffect(() => { if (left === 0 && !submitted) handleSubmit(); }, [left]);

  const q = passageData.questions[currentQ];
  const totalQ = passageData.questions.length;

  const getStatus = (i) => {
    if (statuses[i]) return statuses[i];
    return 'not-visited';
  };

  const selectOption = (optIdx) => {
    if (submitted) return;
    setSelections(prev => ({ ...prev, [currentQ]: optIdx }));
    setStatuses(prev => ({
      ...prev,
      [currentQ]: prev[currentQ] === 'marked' || prev[currentQ] === 'answered-marked' ? 'answered-marked' : 'answered'
    }));
    // In training mode, immediately show explanation
    if (!examMode) {
      setShowExplanation(prev => ({ ...prev, [currentQ]: true }));
    }
  };

  const markForReview = () => {
    if (submitted) return;
    setStatuses(prev => {
      const cur = prev[currentQ];
      if (cur === 'answered' || cur === 'answered-marked') return { ...prev, [currentQ]: 'answered-marked' };
      return { ...prev, [currentQ]: 'marked' };
    });
    goNext();
  };

  const clearResponse = () => {
    if (submitted) return;
    setSelections(prev => { const n = {...prev}; delete n[currentQ]; return n; });
    setStatuses(prev => { const n = {...prev}; delete n[currentQ]; return n; });
    setShowExplanation(prev => { const n = {...prev}; delete n[currentQ]; return n; });
  };

  const goNext = () => {
    if (currentQ < totalQ - 1) {
      setCurrentQ(currentQ + 1);
      setShowHint(false);
      // mark as not-answered if we skipped
      if (statuses[currentQ] === undefined || statuses[currentQ] === 'not-visited') {
        setStatuses(prev => ({ ...prev, [currentQ]: 'not-answered' }));
      }
    }
  };

  const goPrev = () => {
    if (currentQ > 0) { setCurrentQ(currentQ - 1); setShowHint(false); }
  };

  const saveAndNext = () => {
    if (selections[currentQ] === undefined) {
      setStatuses(prev => ({ ...prev, [currentQ]: 'not-answered' }));
    }
    goNext();
  };

  const handleSubmit = () => {
    // Mark all unvisited as not-answered
    const newStatuses = { ...statuses };
    for (let i = 0; i < totalQ; i++) {
      if (!newStatuses[i]) newStatuses[i] = 'not-answered';
    }
    setStatuses(newStatuses);
    setSubmitted(true);
    // Show all explanations
    const allExpl = {};
    for (let i = 0; i < totalQ; i++) allExpl[i] = true;
    setShowExplanation(allExpl);
    setCurrentQ(0);
  };

  // Build results for parent
  const buildResults = () => ({
    stats: passageData.questions.map((q, i) => ({
      qType: q.qType,
      passageType: passageData.passageType,
      correct: selections[i] === q.correctIndex
    })),
    selections: { ...selections }
  });

  const palette_class = (i) => {
    const s = getStatus(i);
    const base = 'w-8 h-8 rounded font-semibold text-xs flex items-center justify-center cursor-pointer transition-all';
    const ring = i === currentQ ? ' q-current-ring scale-110' : '';
    if (s === 'answered') return `${base} q-answered${ring}`;
    if (s === 'not-answered') return `${base} q-not-answered${ring}`;
    if (s === 'marked') return `${base} q-marked${ring}`;
    if (s === 'answered-marked') return `${base} q-answered-marked${ring}`;
    return `${base} q-not-visited${ring}`;
  };

  const timerColor = left < 120 ? 'text-red-600' : left < 300 ? 'text-amber-600' : 'text-nta-blue';
  const timerBg = left < 120 ? 'bg-red-50 border-red-200' : left < 300 ? 'bg-amber-50 border-amber-200' : 'bg-nta-pale border-blue-200';

  const isCorrect = selections[currentQ] === q.correctIndex;
  const isAnswered = selections[currentQ] !== undefined;
  const showReveal = submitted || (!examMode && isAnswered);

  return (
    <div className="min-h-screen bg-gray-100 flex flex-col">
      {/* â”€â”€ TOP BAR â”€â”€ */}
      <div className="nta-header text-white shadow-lg flex-shrink-0">
        <div className="max-w-screen-xl mx-auto px-3 py-2 flex items-center gap-3">
          <button onClick={onHome} className="text-blue-200 hover:text-white text-xs border border-blue-400 px-2 py-1 rounded transition-colors">â† Home</button>
          <div className="flex-1">
            <div className="font-bold text-sm hidden sm:block">CUET â€” Section I: English Language</div>
            <div className="text-blue-300 text-xs">{passageData.passageType} Â· {passageData.difficulty}</div>
          </div>
          <div className={`border rounded-lg px-3 py-1.5 font-mono text-sm font-bold ${timerColor} ${timerBg} ${left < 120 ? 'timer-warning' : ''} transition-colors`}>
            â± {examMode ? formatted : 'âˆ Training'}
          </div>
          {!submitted && (
            <button onClick={handleSubmit}
              className="bg-red-600 hover:bg-red-700 text-white text-xs px-3 py-2 rounded-lg font-bold transition-colors shadow">
              Submit
            </button>
          )}
          {submitted && (
            <button onClick={() => onFinish(buildResults())}
              className="bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-2 rounded-lg font-bold transition-colors shadow">
              See Results â†’
            </button>
          )}
        </div>
      </div>

      {/* â”€â”€ SECTION HEADER â”€â”€ */}
      <div className="bg-nta-pale border-b border-blue-200 px-4 py-2 flex items-center justify-between flex-shrink-0">
        <div className="text-xs text-gray-600 font-medium">
          <span className="font-bold text-nta-blue">{passageData.title}</span>
          <span className="ml-3 text-gray-400">Â· Reading Comprehension Â· Q {currentQ+1} of {totalQ}</span>
        </div>
        <div className="flex items-center gap-2 text-xs">
          {!examMode && <span className="bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full font-medium">ğŸ“ Training Mode</span>}
          {examMode && <span className="bg-red-100 text-red-700 px-2 py-0.5 rounded-full font-medium">ğŸ† Exam Mode</span>}
          <button onClick={() => setShowPassage(p=>!p)} className="sm:hidden bg-gray-200 text-gray-700 px-2 py-0.5 rounded text-xs">
            {showPassage ? 'ğŸ“ Questions' : 'ğŸ“– Passage'}
          </button>
        </div>
      </div>

      {/* â”€â”€ MAIN CONTENT â”€â”€ */}
      <div className="flex-1 max-w-screen-xl mx-auto w-full flex flex-col lg:flex-row gap-0 overflow-hidden">

        {/* â”€â”€ PASSAGE (left) â”€â”€ */}
        <div className={`lg:w-5/12 bg-white border-r border-gray-200 overflow-y-auto flex-shrink-0 ${showPassage ? 'block' : 'hidden sm:block'}`}>
          <div className="p-4 md:p-5">
            <div className="bg-nta-pale border border-blue-200 rounded-lg px-3 py-2 mb-4">
              <div className="text-xs font-bold text-nta-blue uppercase tracking-wide">ğŸ“– Reading Passage</div>
              <div className="text-xs text-gray-500 mt-0.5">Read carefully before answering</div>
            </div>
            <div className="prose prose-sm max-w-none">
              <h2 className="text-sm font-bold text-gray-800 mb-3 border-l-4 border-nta-blue pl-3">{passageData.title}</h2>
              {passageData.passage.split('\n\n').map((para, i) => (
                <p key={i} className="text-gray-800 text-sm leading-relaxed mb-4" style={{textAlign:'justify'}}>{para}</p>
              ))}
            </div>
            {/* Key line highlight for current question after reveal */}
            {showReveal && q.keyLine && (
              <div className="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                <div className="text-xs font-bold text-yellow-800 mb-1">ğŸ” Key Evidence in Passage:</div>
                <div className="text-xs text-yellow-900 italic leading-relaxed">"{q.keyLine}"</div>
              </div>
            )}
          </div>
        </div>

        {/* â”€â”€ QUESTIONS (middle) â”€â”€ */}
        <div className={`flex-1 overflow-y-auto bg-white ${!showPassage ? 'block' : 'hidden sm:block'} lg:block`}>
          <div className="p-4 md:p-5">
            {/* Question Header */}
            <div className="flex items-center justify-between mb-4">
              <div className="flex items-center gap-2">
                <span className="bg-nta-blue text-white text-xs font-bold px-2.5 py-1 rounded-lg">Q {currentQ+1}</span>
                <span className={`text-xs px-2 py-0.5 rounded-full font-medium border ${
                  q.qType === 'Factual Retrieval' ? 'bg-blue-50 text-blue-700 border-blue-200' :
                  q.qType === 'Tone / Attitude' ? 'bg-purple-50 text-purple-700 border-purple-200' :
                  q.qType === 'Inference' ? 'bg-orange-50 text-orange-700 border-orange-200' :
                  q.qType === 'Title / Central Theme' ? 'bg-green-50 text-green-700 border-green-200' :
                  q.qType === 'Vocabulary in Context' ? 'bg-pink-50 text-pink-700 border-pink-200' :
                  'bg-gray-50 text-gray-700 border-gray-200'
                }`}>{q.qType}</span>
              </div>
              <div className="text-xs text-gray-400">Marks: +5 | -1</div>
            </div>

            {/* Question Text */}
            <div className="bg-gray-50 border border-gray-200 rounded-xl p-4 mb-5">
              <p className="text-gray-900 text-sm leading-relaxed font-medium">{q.question}</p>
            </div>

            {/* Options */}
            <div className="space-y-2.5 mb-5">
              {q.options.map((opt, oi) => {
                const isSelected = selections[currentQ] === oi;
                const isCorrectOpt = oi === q.correctIndex;
                let extraClass = 'border-gray-200 bg-white hover:border-nta-blue hover:bg-nta-pale';
                if (showReveal) {
                  if (isCorrectOpt) extraClass = 'option-correct border-green-400';
                  else if (isSelected && !isCorrectOpt) extraClass = 'option-wrong border-red-400';
                  else extraClass = 'border-gray-200 bg-white opacity-60';
                } else if (isSelected) {
                  extraClass = 'border-nta-blue bg-nta-pale';
                }

                return (
                  <button key={oi} onClick={() => selectOption(oi)} disabled={submitted && examMode}
                    className={`w-full flex items-start gap-3 p-3 rounded-xl border-2 text-left transition-all ${extraClass} ${!submitted || !examMode ? 'cursor-pointer' : 'cursor-default'}`}>
                    <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center text-xs font-bold flex-shrink-0 mt-0.5 ${
                      showReveal && isCorrectOpt ? 'bg-green-500 border-green-500 text-white' :
                      showReveal && isSelected && !isCorrectOpt ? 'bg-red-500 border-red-500 text-white' :
                      isSelected ? 'bg-nta-blue border-nta-blue text-white' :
                      'bg-white border-gray-300 text-gray-500'
                    }`}>
                      {String.fromCharCode(65+oi)}
                    </div>
                    <span className="text-sm text-gray-800 leading-relaxed">{opt}</span>
                    {showReveal && isCorrectOpt && <span className="ml-auto text-green-600 text-lg flex-shrink-0">âœ“</span>}
                    {showReveal && isSelected && !isCorrectOpt && <span className="ml-auto text-red-500 text-lg flex-shrink-0">âœ—</span>}
                  </button>
                );
              })}
            </div>

            {/* Training Mode: Hint */}
            {!examMode && !submitted && !isAnswered && (
              <div className="mb-4">
                <button onClick={() => setShowHint(p=>!p)} className="text-xs text-nta-blue underline font-medium hover:text-nta-light">
                  {showHint ? 'â–² Hide Hint' : 'ğŸ’¡ Show Strategy Hint (optional)'}
                </button>
                {showHint && (
                  <div className="mt-2 p-3 bg-amber-50 border border-amber-200 rounded-xl slide-in">
                    <div className="text-xs font-bold text-amber-800 mb-1">ğŸ§­ Strategy Hint:</div>
                    <p className="text-xs text-amber-900 leading-relaxed">{q.hint}</p>
                  </div>
                )}
              </div>
            )}

            {/* Explanation (shown after answer or submit) */}
            {showReveal && showExplanation[currentQ] && (
              <div className="mt-4 space-y-3 slide-in">
                {/* Correct/Wrong indicator */}
                <div className={`flex items-center gap-2 p-3 rounded-xl font-bold text-sm ${
                  isAnswered ? (isCorrect ? 'bg-green-50 text-green-800 border border-green-200' : 'bg-red-50 text-red-800 border border-red-200') : 'bg-gray-50 text-gray-700 border border-gray-200'
                }`}>
                  {isAnswered ? (isCorrect ? 'âœ… Correct! +5 marks' : 'âŒ Wrong! -1 mark') : 'âšª Not Attempted'}
                </div>

                {/* Expert Explanation */}
                <div className="bg-blue-50 border border-blue-200 rounded-xl p-4">
                  <div className="text-xs font-bold text-nta-blue mb-2 flex items-center gap-2">
                    <span>ğŸ“</span> Expert Explanation
                  </div>
                  <p className="text-xs text-gray-800 leading-relaxed">{q.explanation}</p>
                </div>

                {/* Trap identified */}
                {q.trapType && q.trapType !== 'None' && (
                  <div className="bg-orange-50 border border-orange-200 rounded-xl p-3">
                    <div className="text-xs font-bold text-orange-800 mb-1">ğŸª¤ Trap Used in This Question:</div>
                    <span className="trap-badge bg-orange-100 text-orange-800 border border-orange-300">{q.trapType}</span>
                    <p className="text-xs text-orange-700 mt-2">{getTrapExplanation(q.trapType)}</p>
                  </div>
                )}

                {/* Question type strategy */}
                <div className="bg-purple-50 border border-purple-200 rounded-xl p-3">
                  <div className="text-xs font-bold text-purple-800 mb-1">ğŸ“ {q.qType} â€” Strategy:</div>
                  <p className="text-xs text-purple-900 leading-relaxed">{getQTypeStrategy(q.qType)}</p>
                </div>
              </div>
            )}

            {/* â”€â”€ BOTTOM BUTTONS (NTA-style) â”€â”€ */}
            <div className="mt-6 pt-4 border-t border-gray-200">
              {!submitted ? (
                <div className="flex flex-wrap gap-2">
                  <button onClick={markForReview}
                    className="flex-1 min-w-[140px] bg-purple-600 hover:bg-purple-700 text-white text-xs font-semibold py-2.5 px-3 rounded-lg transition-colors">
                    ğŸ”– Mark for Review & Next
                  </button>
                  <button onClick={clearResponse}
                    className="bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs font-semibold py-2.5 px-3 rounded-lg transition-colors">
                    ğŸ—‘ Clear
                  </button>
                  <button onClick={saveAndNext}
                    className="flex-1 min-w-[100px] bg-nta-blue hover:bg-nta-light text-white text-xs font-bold py-2.5 px-3 rounded-lg transition-colors">
                    Save & Next â†’
                  </button>
                </div>
              ) : (
                <div className="flex gap-2 justify-between">
                  <button onClick={goPrev} disabled={currentQ===0}
                    className="bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs font-semibold py-2 px-4 rounded-lg transition-colors disabled:opacity-40">
                    â† Prev
                  </button>
                  <button onClick={() => onFinish(buildResults())}
                    className="flex-1 bg-green-600 hover:bg-green-700 text-white text-sm font-bold py-2 px-4 rounded-lg transition-colors">
                    See Final Results & Analysis â†’
                  </button>
                  <button onClick={goNext} disabled={currentQ===totalQ-1}
                    className="bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs font-semibold py-2 px-4 rounded-lg transition-colors disabled:opacity-40">
                    Next â†’
                  </button>
                </div>
              )}

            </div>
          </div>
        </div>

        {/* â”€â”€ RIGHT PANEL (Question Palette + Legend) â”€â”€ */}
        <div className="lg:w-56 bg-gray-50 border-l border-gray-200 flex-shrink-0 overflow-y-auto hidden lg:block">
          <div className="p-4">
            {/* Legend */}
            <div className="mb-4 space-y-1.5">
              <div className="text-xs font-bold text-gray-600 mb-2 uppercase tracking-wide">Legend</div>
              {[
                { cls:'q-not-visited', label:'Not Visited' },
                { cls:'q-answered', label:'Answered' },
                { cls:'q-not-answered', label:'Not Answered' },
                { cls:'q-marked', label:'Marked for Review' },
                { cls:'q-answered-marked', label:'Answered + Marked' },
              ].map(({ cls, label }) => (
                <div key={label} className="flex items-center gap-2">
                  <div className={`w-5 h-5 rounded text-xs flex items-center justify-center ${cls}`}>1</div>
                  <span className="text-xs text-gray-600">{label}</span>
                </div>
              ))}
            </div>

            <div className="text-xs font-bold text-gray-600 mb-2 uppercase tracking-wide">Question Palette</div>
            <div className="grid grid-cols-4 gap-1.5">
              {passageData.questions.map((_, i) => (
                <button key={i} onClick={() => setCurrentQ(i)} className={palette_class(i)}>
                  {i+1}
                </button>
              ))}
            </div>

            {/* Summary counts */}
            <div className="mt-4 space-y-1">
              {[
                { cls:'q-answered', label:'Answered', count: Object.values(statuses).filter(s=>s==='answered'||s==='answered-marked').length },
                { cls:'q-not-answered', label:'Not Answered', count: Object.values(statuses).filter(s=>s==='not-answered').length },
                { cls:'q-marked', label:'Marked', count: Object.values(statuses).filter(s=>s==='marked'||s==='answered-marked').length },
                { cls:'q-not-visited', label:'Not Visited', count: totalQ - Object.keys(statuses).length },
              ].map(({cls,label,count}) => (
                <div key={label} className="flex items-center justify-between text-xs">
                  <div className="flex items-center gap-1.5">
                    <div className={`w-4 h-4 rounded text-xs flex items-center justify-center ${cls}`}></div>
                    <span className="text-gray-600">{label}</span>
                  </div>
                  <span className="font-bold text-gray-800">{count}</span>
                </div>
              ))}
            </div>

            {!submitted && (
              <button onClick={handleSubmit}
                className="mt-4 w-full bg-nta-blue hover:bg-nta-light text-white text-xs font-bold py-2.5 rounded-lg transition-colors shadow">
                Submit Test
              </button>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

// 4. RESULTS SCREEN
function ResultsScreen({ passageData, selections, stats, onHome, onRetry }) {
  const results = passageData.questions.map((q, i) => ({
    q, i,
    selected: selections[i],
    correct: selections[i] === q.correctIndex,
    attempted: selections[i] !== undefined
  }));

  const correct = results.filter(r => r.correct).length;
  const wrong = results.filter(r => r.attempted && !r.correct).length;
  const notAttempted = results.filter(r => !r.attempted).length;
  const marks = correct * 5 + wrong * (-1);
  const maxMarks = passageData.questions.length * 5;
  const pct = Math.round((correct / passageData.questions.length) * 100);

  const weakQTypes = results.filter(r => !r.correct).map(r => r.q.qType);
  const uniqueWeakTypes = [...new Set(weakQTypes)];

  const gradeInfo = pct === 100 ? { emoji:'ğŸ†', label:'PERFECT SCORE!', color:'text-green-600', bg:'bg-green-50', border:'border-green-200' }
    : pct >= 83 ? { emoji:'â­', label:'Excellent', color:'text-blue-600', bg:'bg-blue-50', border:'border-blue-200' }
    : pct >= 67 ? { emoji:'ğŸ“ˆ', label:'Good', color:'text-amber-600', bg:'bg-amber-50', border:'border-amber-200' }
    : { emoji:'ğŸ’ª', label:'Keep Practicing', color:'text-red-600', bg:'bg-red-50', border:'border-red-200' };

  return (
    <div className="min-h-screen bg-gray-100">
      <div className="nta-header text-white py-3 px-6 flex items-center justify-between shadow-lg">
        <div className="font-bold">CUET RC Master â€” Results & Analysis</div>
        <div className="flex gap-2">
          <button onClick={onRetry} className="bg-white/20 hover:bg-white/30 text-white text-xs px-3 py-1.5 rounded-lg font-medium transition-colors">ğŸ”„ New Passage</button>
          <button onClick={onHome} className="bg-white/20 hover:bg-white/30 text-white text-xs px-3 py-1.5 rounded-lg font-medium transition-colors">ğŸ  Home</button>
        </div>
      </div>

      <div className="max-w-4xl mx-auto p-4 md:p-6 space-y-5">
        {/* Score Card */}
        <div className={`${gradeInfo.bg} border-2 ${gradeInfo.border} rounded-2xl p-6 text-center fade-in`}>
          <div className="text-5xl mb-2">{gradeInfo.emoji}</div>
          <div className={`text-2xl font-bold ${gradeInfo.color} mb-1`}>{gradeInfo.label}</div>
          <div className="text-5xl font-bold text-gray-900 my-3">{marks} <span className="text-2xl text-gray-500">/ {maxMarks}</span></div>
          <div className="text-sm text-gray-600">{pct}% accuracy</div>

          <div className="grid grid-cols-3 gap-3 mt-5">
            <div className="bg-white rounded-xl p-3 border border-green-200">
              <div className="text-2xl font-bold text-green-600">{correct}</div>
              <div className="text-xs text-gray-500">Correct (+{correct*5})</div>
            </div>
            <div className="bg-white rounded-xl p-3 border border-red-200">
              <div className="text-2xl font-bold text-red-500">{wrong}</div>
              <div className="text-xs text-gray-500">Wrong ({wrong > 0 ? '-'+wrong : 0})</div>
            </div>
            <div className="bg-white rounded-xl p-3 border border-gray-200">
              <div className="text-2xl font-bold text-gray-400">{notAttempted}</div>
              <div className="text-xs text-gray-500">Skipped (0)</div>
            </div>
          </div>
        </div>

        {/* Weakness Analysis */}
        {uniqueWeakTypes.length > 0 && (
          <div className="bg-white rounded-xl border border-orange-200 p-5 fade-in">
            <h3 className="font-bold text-gray-800 mb-3 flex items-center gap-2">
              <span>ğŸ¯</span> Areas to Improve â€” Expert Diagnosis
            </h3>
            <div className="space-y-3">
              {uniqueWeakTypes.map(type => (
                <div key={type} className="p-3 bg-orange-50 border border-orange-100 rounded-xl">
                  <div className="font-semibold text-orange-800 text-sm mb-1">âŒ {type}</div>
                  <p className="text-xs text-orange-700 leading-relaxed">{getQTypeStrategy(type)}</p>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Question-by-question review */}
        <div className="bg-white rounded-xl border border-gray-200 p-5 fade-in">
          <h3 className="font-bold text-gray-800 mb-4 flex items-center gap-2">
            <span>ğŸ“‹</span> Question-by-Question Review
          </h3>
          <div className="space-y-4">
            {results.map(({ q, i, selected, correct: isCorr, attempted }) => (
              <div key={i} className={`border-2 rounded-xl p-4 ${isCorr ? 'border-green-200 bg-green-50' : attempted ? 'border-red-200 bg-red-50' : 'border-gray-200 bg-gray-50'}`}>
                <div className="flex items-center gap-2 mb-2">
                  <span className="text-lg">{isCorr ? 'âœ…' : attempted ? 'âŒ' : 'âšª'}</span>
                  <span className="font-bold text-sm text-gray-800">Q{i+1}: {q.qType}</span>
                  {q.trapType && q.trapType !== 'None' && (
                    <span className="trap-badge bg-orange-100 text-orange-700 border border-orange-200 text-xs ml-auto">{q.trapType}</span>
                  )}
                </div>
                <p className="text-xs text-gray-700 mb-3 leading-relaxed">{q.question}</p>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-1.5 mb-3">
                  {q.options.map((opt, oi) => (
                    <div key={oi} className={`text-xs p-2 rounded-lg flex items-start gap-2 ${
                      oi === q.correctIndex ? 'bg-green-100 text-green-800 font-semibold border border-green-300' :
                      oi === selected && !isCorr ? 'bg-red-100 text-red-700 border border-red-300' :
                      'bg-white text-gray-600 border border-gray-200'
                    }`}>
                      <span className="font-bold flex-shrink-0">{String.fromCharCode(65+oi)}.</span>
                      <span>{opt}</span>
                    </div>
                  ))}
                </div>
                <div className="bg-white/70 border border-blue-100 rounded-lg p-2.5">
                  <div className="text-xs font-bold text-nta-blue mb-1">ğŸ’¡ Expert Explanation:</div>
                  <p className="text-xs text-gray-700 leading-relaxed">{q.explanation}</p>
                </div>
              </div>
            ))}
          </div>
        </div>

        {/* Action Buttons */}
        <div className="grid grid-cols-2 gap-3 pb-6">
          <button onClick={onRetry} className="bg-nta-blue text-white font-bold py-3 rounded-xl hover:bg-nta-light transition-colors shadow-lg">
            ğŸ”„ Generate New Passage
          </button>
          <button onClick={onHome} className="bg-white text-nta-blue font-bold py-3 rounded-xl hover:bg-nta-pale border-2 border-nta-blue transition-colors">
            ğŸ  Back to Dashboard
          </button>
        </div>
      </div>
    </div>
  );
}

// â”€â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getQTypeStrategy(type) {
  const strategies = {
    'Factual Retrieval': 'Scan the passage for the exact keyword from the question. The answer is directly stated â€” find it word-for-word or as a clear paraphrase. Never use outside knowledge.',
    'Tone / Attitude': 'Find ONE sentence that shows the author\'s emotion. Ask: Is the author FOR, AGAINST, or NEUTRAL? Match to the tone word. Eliminate the opposite tone first.',
    'Inference': 'The answer is NOT stated but logically implied. Rule: never pick an option that goes BEYOND what the passage suggests. Extreme options are ALWAYS wrong for inference.',
    'Title / Central Theme': 'The title must cover the ENTIRE passage, not just one paragraph. Eliminate options that are too narrow (one detail) or too broad. The correct option is the middle-ground.',
    'Vocabulary in Context': 'Ignore the word\'s normal dictionary meaning. Replace it with each answer option in the original sentence and pick the one that makes the sentence make sense.',
    'Main Idea of Paragraph': 'Almost always the first OR last sentence of that paragraph. Never pick a supporting detail â€” the main idea must cover the WHOLE paragraph.',
    "Author's Purpose": 'Ask: Why did the author write this? To inform / persuade / warn / criticize / entertain? Look at the overall argument and conclusion, not just one sentence.',
  };
  return strategies[type] || 'Read carefully and eliminate options that are not directly supported by the passage text.';
}

function getTrapExplanation(trap) {
  const explanations = {
    'Extreme Language': 'Words like "always," "never," "only," "completely" signal a trap. Real passages are nuanced. Eliminate any option using absolute language.',
    'True but Not in Passage': 'This option is factually correct in real life but NOT stated or implied in the passage. You must answer from the passage only, never from prior knowledge.',
    'Partially Correct': 'This option is true for one paragraph or one detail in the passage, but NOT for the whole passage. Always check if an option applies to the entire text.',
    'Too Narrow for Title': 'This option would make a good title for ONE paragraph only, not the whole passage. A correct title must cover all the key ideas.',
    'Opposite Tone': 'This option uses a tone word that is the exact opposite of the author\'s actual tone. Eliminate options that completely contradict the overall feeling of the passage.',
    'Synonym Substitution': 'The correct answer paraphrases the passage rather than copying its exact words. If you only look for word-for-word matches, you will miss paraphrase-based correct answers.',
    'Attractive Distractor': 'This option uses words FROM the passage but changes the meaning slightly. It looks very tempting but fails on careful examination.',
    'None': '',
  };
  return explanations[trap] || '';
}

// â”€â”€â”€ ROOT APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function App() {
  const [apiKey, setApiKey] = useState(() => {
    try { return localStorage.getItem(API_KEY_STORAGE) || ''; } catch(e) { return ''; }
  });
  const [stats, setStats] = useState(() => loadStats());
  const [screen, setScreen] = useState('home'); // home | loading | exam | results
  const [sessionConfig, setSessionConfig] = useState(null);
  const [passageData, setPassageData] = useState(null);
  const [error, setError] = useState(null);
  const [selections, setSelections] = useState({});

  const handleStart = async (config) => {
    setSessionConfig(config);
    setError(null);
    setScreen('loading');
    try {
      const weakTypes = getWeakQTypes(stats);
      const data = await generateRCPassage(apiKey, config.passageType, config.difficulty, weakTypes);
      setPassageData(data);
      setSelections({});
      setScreen('exam');
    } catch(e) {
      setError(e.message);
      setScreen('home');
    }
  };

  return (
    <div>
      {error && (
        <div className="fixed top-4 left-1/2 -translate-x-1/2 z-50 bg-red-600 text-white px-5 py-3 rounded-xl shadow-xl text-sm font-medium max-w-sm text-center">
          âŒ {error}
          <button onClick={() => setError(null)} className="ml-3 underline">Dismiss</button>
        </div>
      )}

      {screen === 'home' && (
        <SetupScreen
          apiKey={apiKey}
          setApiKey={setApiKey}
          stats={stats}
          onStart={handleStart}
        />
      )}

      {screen === 'loading' && sessionConfig && (
        <LoadingScreen passageType={sessionConfig.passageType} difficulty={sessionConfig.difficulty} />
      )}

      {screen === 'exam' && passageData && (
        <ExamScreen
          passageData={passageData}
          examMode={sessionConfig?.examMode}
          stats={stats}
          onFinish={(payload) => {
            const results = payload.stats || payload;
            const sel = payload.selections || {};
            const newStats = updateStats(stats, results);
            setStats(newStats);
            saveStats(newStats);
            setSelections(sel);
            setScreen('results');
          }}
          onHome={() => setScreen('home')}
        />
      )}

      {screen === 'results' && passageData && (
        <ResultsScreen
          passageData={passageData}
          selections={selections}
          stats={stats}
          onHome={() => setScreen('home')}
          onRetry={() => handleStart(sessionConfig)}
        />
      )}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
