<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>CUET RC Master</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Serif+Display:ital@0;1&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script>
tailwind.config = {
  theme: {
    extend: {
      fontFamily: {
        sans: ['DM Sans','sans-serif'],
        serif: ['DM Serif Display','serif'],
        mono: ['JetBrains Mono','monospace']
      },
      colors: {
        ink: { DEFAULT:'#0f172a', 50:'#f8fafc', 100:'#f1f5f9', 200:'#e2e8f0', 300:'#cbd5e1', 400:'#94a3b8', 500:'#64748b', 600:'#475569', 700:'#334155', 800:'#1e293b', 900:'#0f172a' },
        brand: { DEFAULT:'#1d4ed8', light:'#3b82f6', pale:'#eff6ff', dark:'#1e3a8a', accent:'#0ea5e9' },
        good: '#16a34a', bad: '#dc2626', warn: '#d97706', review: '#7c3aed'
      }
    }
  }
};
</script>
<style>
*, *::before, *::after { box-sizing: border-box; }
html, body { height: 100%; margin: 0; padding: 0; }
body { font-family: 'DM Sans', sans-serif; background: #f8fafc; color: #0f172a; -webkit-font-smoothing: antialiased; }
#root { height: 100%; }

/* Custom scrollbar */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }

/* Question palette states */
.qs { display:flex; align-items:center; justify-content:center; width:36px; height:36px; border-radius:8px; font-size:13px; font-weight:600; cursor:pointer; transition: all .15s; border: 2px solid transparent; flex-shrink: 0; }
.qs-not-visited { background:#e2e8f0; color:#64748b; border-color:#cbd5e1; }
.qs-answered    { background:#16a34a; color:white; border-color:#15803d; }
.qs-not-answered{ background:#dc2626; color:white; border-color:#b91c1c; }
.qs-marked      { background:#7c3aed; color:white; border-color:#6d28d9; }
.qs-answered-marked { background:#7c3aed; color:white; border-color:#6d28d9; position:relative; }
.qs-answered-marked::after { content:'âœ“'; position:absolute; bottom:-2px; right:1px; font-size:8px; color:#c4b5fd; }
.qs-current { box-shadow: 0 0 0 3px #1d4ed8, 0 0 0 5px #bfdbfe; transform: scale(1.1); }

/* Option states */
.opt-default  { border:2px solid #e2e8f0; background:white; }
.opt-selected { border:2px solid #1d4ed8; background:#eff6ff; }
.opt-correct  { border:2px solid #16a34a; background:#dcfce7; }
.opt-wrong    { border:2px solid #dc2626; background:#fee2e2; }
.opt-show-correct { border:2px solid #16a34a; background:#dcfce7; opacity:.7; }

/* Animations */
@keyframes slideUp   { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }
@keyframes fadeIn    { from{opacity:0} to{opacity:1} }
@keyframes pulse-red { 0%,100%{box-shadow:0 0 0 0 rgba(220,38,38,.4)} 50%{box-shadow:0 0 0 6px rgba(220,38,38,0)} }
.slide-up { animation: slideUp .3s ease forwards; }
.fade-in  { animation: fadeIn .4s ease forwards; }
.pulse-red { animation: pulse-red 1.2s infinite; }

/* Mobile safe zones */
@supports (padding-bottom: env(safe-area-inset-bottom)) {
  .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
}

/* â”€â”€ CRITICAL MOBILE SCROLL FIXES â”€â”€ */
/* Use dynamic viewport height so browser chrome doesn't cut off the tab bar */
.exam-root {
  height: 100vh;           /* fallback for old browsers */
  height: 100dvh;          /* actual visible viewport on mobile â€” excludes address bar */
}
/* Smooth native momentum scrolling on iOS */
.scroll-panel {
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;  /* iOS momentum scroll */
  overscroll-behavior-y: contain;     /* prevent scroll leaking to parent */
}
/* Bottom tab bar always above keyboard / safe area */
.tab-bar {
  flex-shrink: 0;
  background: white;
  border-top: 1px solid #e2e8f0;
  padding-bottom: env(safe-area-inset-bottom, 0px);
}
/* Active tab indicator */
.tab-btn { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 10px 4px 8px; position: relative; transition: color .15s; color: #94a3b8; }
.tab-btn.tab-active { color: #1d4ed8; }
.tab-btn.tab-active::after { content: ''; position: absolute; top: 0; left: 20%; right: 20%; height: 2.5px; background: #1d4ed8; border-radius: 0 0 3px 3px; }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;

// â”€â”€â”€ CONSTANTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const API_KEY_STORAGE = 'cuet_rc_api_key';
const STATS_STORAGE   = 'cuet_rc_stats_v4';
const GEMINI_URL = key => `https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${key}`;

const PASSAGE_TYPES = ['Scientific/Factual','Literary/Narrative','Philosophical/Abstract','Social/Current Affairs','Environmental','Historical/Cultural','Psychological'];
const DIFFICULTY_LEVELS = ['Easy','Medium','Hard','CUET Expert'];
const Q_TYPES = ['Factual Retrieval','Tone / Attitude','Inference','Title / Central Theme','Vocabulary in Context','Main Idea of Paragraph',"Author's Purpose"];

// â”€â”€â”€ GEMINI SERVICE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function generateRCPassage(apiKey, passageType, difficulty, weakQTypes = []) {
  const focusNote = weakQTypes.length > 0
    ? `IMPORTANT: Include extra questions of these types since the student is weak at them: ${weakQTypes.join(', ')}.`
    : '';

  const prompt = `You are an expert NTA (National Testing Agency) CUET English paper setter who has set CUET papers from 2022-2025.

Generate a CUET-style Reading Comprehension passage and exactly 6 questions.

SPECIFICATIONS:
- Passage Type: ${passageType}
- Difficulty: ${difficulty}
- Passage Length: 280-380 words
- Style: Exactly like real CUET passages â€” academic, sophisticated vocabulary, suitable for 12th grade
${focusNote}

QUESTION TYPES TO INCLUDE (pick 6 from these, vary them):
- Factual Retrieval: Direct answer in passage
- Tone / Attitude: Author's tone or attitude
- Inference: Implied meaning NOT directly stated
- Title / Central Theme: What title best suits the passage
- Vocabulary in Context: Word/phrase meaning in context
- Main Idea of Paragraph: What a specific paragraph is about
- Author's Purpose: Why the author wrote this

STRICT RULES FOR QUESTIONS (exactly how NTA sets them):
- Correct answer must be unambiguously correct
- Wrong options must be plausible but clearly incorrect on careful analysis
- Include at least 2 trap options (extreme language / true-but-not-in-passage / partially correct)
- For Inference questions: correct answer must never go "beyond" what the text implies
- For Title questions: wrong options must be either too narrow or too broad
- Explanation must teach the STRATEGY, not just state the answer

Respond ONLY with valid JSON â€” no markdown, no extra text:
{
  "passageType": "${passageType}",
  "difficulty": "${difficulty}",
  "title": "Short descriptive title of the passage",
  "passage": "Full passage text here. Use \\n\\n to separate paragraphs.",
  "questions": [
    {
      "qType": "one of the question types above",
      "question": "Question text exactly as it would appear in CUET exam",
      "options": ["Option A text", "Option B text", "Option C text", "Option D text"],
      "correctIndex": 0,
      "trapType": "which trap does this question use (or 'None')",
      "hint": "One sentence strategy hint â€” tell WHERE in passage to look and HOW to decide",
      "explanation": "2-3 sentence expert explanation: Why correct answer is right + Why each wrong option is wrong + What strategy to use",
      "keyLine": "Exact phrase from passage that proves the answer (for factual/inference questions)"
    }
  ]
}`;

  const res = await fetch(GEMINI_URL(apiKey.trim()), {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      contents: [{ role: 'user', parts: [{ text: prompt }] }],
      generationConfig: {
        // NOTE: responseMimeType is intentionally omitted â€” it is incompatible with thinking mode.
        temperature: 0.8,
        maxOutputTokens: 8000,  // higher ceiling: thinking consumes tokens before the output
        thinkingConfig: {
          thinkingLevel: 'HIGH'  // deep reasoning â†’ much better question quality
        }
      }
    })
  });

  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    const msg = err?.error?.message || `HTTP ${res.status}`;
    if (res.status === 400) throw new Error('Bad request â€” the model may not support thinking yet. Try again.');
    if (res.status === 401 || res.status === 403) throw new Error('Invalid API key. Check your Gemini API key.');
    if (res.status === 429) throw new Error('Rate limit hit. Please wait 30 seconds and try again.');
    if (res.status === 503 || res.status === 500) throw new Error('Gemini is temporarily unavailable. Try again in a moment.');
    throw new Error(`Gemini error (${res.status}): ${msg}`);
  }

  const data = await res.json();

  // IMPORTANT: When thinking is enabled, Gemini returns multiple parts:
  //   parts[0] = thinking scratchpad  { thought: true, text: "..." }
  //   parts[1] = actual answer        { text: "...JSON..." }
  // We MUST skip thought parts and find the real response part.
  const parts = data?.candidates?.[0]?.content?.parts || [];
  const textPart = parts.find(p => !p.thought && p.text);
  const text = textPart?.text;

  if (!text) {
    const reason = data?.candidates?.[0]?.finishReason;
    if (reason === 'SAFETY') throw new Error('Response blocked by safety filter. Try generating again.');
    if (reason === 'MAX_TOKENS') throw new Error('Response was cut off. Try a simpler configuration.');
    throw new Error('Empty response from Gemini. Please try again.');
  }

  // Strip any accidental markdown fences the model may add
  const cleaned = text.replace(/^```(?:json)?\s*/i, '').replace(/\s*```\s*$/i, '').trim();

  let parsed;
  try {
    parsed = JSON.parse(cleaned);
  } catch (parseErr) {
    throw new Error('Gemini returned malformed JSON. Try generating again.');
  }

  // Validate the shape so we never crash the UI with incomplete data
  if (!parsed.passage || !Array.isArray(parsed.questions) || parsed.questions.length === 0) {
    throw new Error('Gemini response is incomplete. Try generating again.');
  }

  return parsed;
}

// â”€â”€â”€ STATS ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadStats() {
  try {
    const raw = localStorage.getItem(STATS_STORAGE);
    if (raw) return JSON.parse(raw);
  } catch(e) {}
  return { totalAttempted:0, totalCorrect:0, byQType:{}, byPassageType:{}, sessions:[], streak:0, lastDate:null };
}

function saveStats(stats) {
  try { localStorage.setItem(STATS_STORAGE, JSON.stringify(stats)); } catch(e) {}
}

function updateStats(stats, results) {
  const today = new Date().toISOString().split('T')[0];
  const s = { ...stats };
  s.totalAttempted += results.length;
  s.totalCorrect += results.filter(r => r.correct).length;
  results.forEach(r => {
    if (!s.byQType[r.qType]) s.byQType[r.qType] = { correct:0, total:0 };
    s.byQType[r.qType].total++;
    if (r.correct) s.byQType[r.qType].correct++;
    if (!s.byPassageType[r.passageType]) s.byPassageType[r.passageType] = { correct:0, total:0 };
    s.byPassageType[r.passageType].total++;
    if (r.correct) s.byPassageType[r.passageType].correct++;
  });
  s.sessions = [...(s.sessions||[]).slice(-29), { date:today, correct:results.filter(r=>r.correct).length, total:results.length }];
  if (s.lastDate === today) {}
  else if (s.lastDate === new Date(Date.now()-86400000).toISOString().split('T')[0]) s.streak = (s.streak||0)+1;
  else s.streak = 1;
  s.lastDate = today;
  return s;
}

function getWeakQTypes(stats) {
  return Object.entries(stats.byQType)
    .filter(([,v]) => v.total >= 3 && (v.correct/v.total) < 0.7)
    .map(([k]) => k).slice(0,3);
}

function getQTypeStrategy(type) {
  const m = {
    'Factual Retrieval': 'Scan for the exact keyword from the question. The answer is directly stated â€” never use outside knowledge.',
    'Tone / Attitude': 'Find ONE sentence showing the author\'s emotion. Ask: FOR, AGAINST, or NEUTRAL? Eliminate the opposite tone first.',
    'Inference': 'The answer is NOT stated but implied. Never pick an option that goes BEYOND what the passage suggests. Extreme options are always wrong.',
    'Title / Central Theme': 'The title must cover the ENTIRE passage. Eliminate too-narrow or too-broad options.',
    'Vocabulary in Context': 'Ignore the normal dictionary meaning. Replace the word with each option in the original sentence.',
    'Main Idea of Paragraph': 'Usually the first or last sentence of that paragraph. Never pick a supporting detail.',
    "Author's Purpose": 'Ask: Why did the author write this? To inform / persuade / warn / criticize / entertain?',
  };
  return m[type] || 'Read carefully and eliminate options not directly supported by the passage.';
}

function getTrapExplanation(trap) {
  const m = {
    'Extreme Language': 'Words like "always," "never," "only" signal a trap. Real passages are nuanced.',
    'True but Not in Passage': 'Factually correct in real life but NOT stated in the passage. Answer only from the passage.',
    'Partially Correct': 'True for one paragraph but NOT the whole passage. Check if it applies to the full text.',
    'Too Narrow for Title': 'Works as a title for ONE paragraph only, not the whole passage.',
    'Opposite Tone': 'Uses a tone word that is the exact opposite of the author\'s actual tone.',
    'Synonym Substitution': 'The correct answer paraphrases instead of copying exact words â€” easy to miss.',
    'Attractive Distractor': 'Uses words FROM the passage but changes the meaning slightly.',
    'None': '',
  };
  return m[trap] || '';
}

// â”€â”€â”€ TIMER HOOK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function useTimer(seconds, running) {
  const [left, setLeft] = useState(seconds);
  const ref = useRef(null);
  useEffect(() => { setLeft(seconds); }, [seconds]);
  useEffect(() => {
    if (!running) { clearInterval(ref.current); return; }
    ref.current = setInterval(() => setLeft(l => Math.max(0, l-1)), 1000);
    return () => clearInterval(ref.current);
  }, [running]);
  const fmt = s => `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
  return { left, formatted: fmt(left), pct: (left/seconds)*100 };
}

// â”€â”€â”€ BADGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function QTypeBadge({ type }) {
  const colors = {
    'Factual Retrieval':   'bg-blue-50 text-blue-700',
    'Tone / Attitude':     'bg-purple-50 text-purple-700',
    'Inference':           'bg-orange-50 text-orange-700',
    'Title / Central Theme':'bg-teal-50 text-teal-700',
    'Vocabulary in Context':'bg-pink-50 text-pink-700',
    'Main Idea of Paragraph':'bg-amber-50 text-amber-700',
    "Author's Purpose":    'bg-indigo-50 text-indigo-700',
  };
  return <span className={`inline-block text-xs font-semibold px-2 py-0.5 rounded-full ${colors[type]||'bg-gray-100 text-gray-600'}`}>{type}</span>;
}

// â”€â”€â”€ SETUP SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function SetupScreen({ apiKey, setApiKey, onStart, stats }) {
  const [localKey, setLocalKey] = useState(apiKey);
  const [showKey, setShowKey] = useState(false);
  const [passageType, setPassageType] = useState('Random');
  const [difficulty, setDifficulty] = useState('Medium');
  const [examMode, setExamMode] = useState(false);
  const [saved, setSaved] = useState(false);
  const acc = stats.totalAttempted > 0 ? Math.round((stats.totalCorrect/stats.totalAttempted)*100) : null;
  const weakTypes = getWeakQTypes(stats);

  const handleSaveKey = () => {
    setApiKey(localKey.trim());
    try { localStorage.setItem(API_KEY_STORAGE, localKey.trim()); } catch(e) {}
    setSaved(true); setTimeout(() => setSaved(false), 2000);
  };

  const handleStart = () => {
    if (!localKey.trim()) { alert('Please enter your Gemini API key first.'); return; }
    const type = passageType === 'Random' ? PASSAGE_TYPES[Math.floor(Math.random()*PASSAGE_TYPES.length)] : passageType;
    onStart({ passageType: type, difficulty, examMode });
  };

  return (
    <div className="min-h-screen bg-ink-100 flex flex-col">
      {/* Header */}
      <header className="bg-brand-dark text-white px-5 py-4 flex items-center justify-between">
        <div>
          <div className="font-serif text-xl leading-tight">CUET RC Master</div>
          <div className="text-brand-accent text-xs mt-0.5 font-medium">AI-Powered Reading Comprehension Trainer</div>
        </div>
        {acc !== null && (
          <div className="text-right">
            <div className="text-2xl font-bold font-mono">{acc}%</div>
            <div className="text-brand-accent text-xs">accuracy</div>
          </div>
        )}
      </header>

      <div className="flex-1 max-w-2xl mx-auto w-full px-4 py-5 space-y-4">

        {/* Stats strip */}
        {stats.totalAttempted > 0 && (
          <div className="grid grid-cols-3 gap-3">
            <div className="bg-white rounded-2xl p-3 text-center shadow-sm border border-ink-200">
              <div className="text-xl font-bold text-good">{stats.totalCorrect}</div>
              <div className="text-xs text-ink-400 mt-0.5">Correct</div>
            </div>
            <div className="bg-white rounded-2xl p-3 text-center shadow-sm border border-ink-200">
              <div className="text-xl font-bold text-bad">{stats.totalAttempted - stats.totalCorrect}</div>
              <div className="text-xs text-ink-400 mt-0.5">Wrong</div>
            </div>
            <div className="bg-white rounded-2xl p-3 text-center shadow-sm border border-ink-200">
              <div className="text-xl font-bold text-review">ğŸ”¥{stats.streak||0}</div>
              <div className="text-xs text-ink-400 mt-0.5">Day streak</div>
            </div>
          </div>
        )}

        {/* API Key Card */}
        <div className="bg-white rounded-2xl p-5 shadow-sm border border-ink-200">
          <div className="flex items-center justify-between mb-3">
            <span className="font-semibold text-ink-800">Gemini API Key</span>
            <span className="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full font-medium">Free</span>
          </div>
          <div className="flex gap-2">
            <div className="relative flex-1">
              <input
                type={showKey ? 'text' : 'password'}
                value={localKey}
                onChange={e => setLocalKey(e.target.value)}
                onKeyDown={e => e.key === 'Enter' && handleSaveKey()}
                placeholder="AIzaSy..."
                className="w-full border border-ink-200 rounded-xl px-4 py-3 text-sm font-mono focus:outline-none focus:border-brand focus:ring-2 focus:ring-brand/20 pr-10"
              />
              <button onClick={() => setShowKey(!showKey)} className="absolute right-3 top-1/2 -translate-y-1/2 text-ink-400 hover:text-ink-600 text-sm">
                {showKey ? 'ğŸ™ˆ' : 'ğŸ‘ï¸'}
              </button>
            </div>
            <button onClick={handleSaveKey}
              className={`px-4 py-3 rounded-xl text-sm font-semibold transition-all ${saved ? 'bg-green-500 text-white' : 'bg-brand text-white hover:bg-brand-light'}`}>
              {saved ? 'âœ“' : 'Save'}
            </button>
          </div>
          {localKey ? (
            <div className="mt-2 flex items-center gap-1.5 text-xs text-green-600">
              <span className="w-1.5 h-1.5 rounded-full bg-green-500 inline-block"></span>
              API key saved â€” ready to generate
            </div>
          ) : (
            <p className="text-xs text-ink-400 mt-2">
              Get free key: <a href="https://aistudio.google.com/apikey" target="_blank" className="text-brand underline">aistudio.google.com/apikey</a>
            </p>
          )}
        </div>

        {/* Settings Card */}
        <div className="bg-white rounded-2xl p-5 shadow-sm border border-ink-200">
          <div className="font-semibold text-ink-800 mb-4">Session Settings</div>

          <div className="space-y-4">
            {/* Passage Type */}
            <div>
              <label className="text-xs font-semibold text-ink-500 uppercase tracking-wider block mb-1.5">Passage Type</label>
              <select value={passageType} onChange={e => setPassageType(e.target.value)}
                className="w-full border border-ink-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-brand bg-ink-50 appearance-none">
                <option>Random</option>
                {PASSAGE_TYPES.map(t => <option key={t}>{t}</option>)}
              </select>
            </div>

            {/* Difficulty */}
            <div>
              <label className="text-xs font-semibold text-ink-500 uppercase tracking-wider block mb-1.5">Difficulty</label>
              <div className="grid grid-cols-4 gap-2">
                {DIFFICULTY_LEVELS.map(d => (
                  <button key={d} onClick={() => setDifficulty(d)}
                    className={`py-2.5 rounded-xl text-sm font-medium transition-all border-2 ${difficulty === d ? 'border-brand bg-brand-pale text-brand font-semibold' : 'border-ink-200 bg-white text-ink-600 hover:border-ink-300'}`}>
                    {d}
                  </button>
                ))}
              </div>
            </div>

            {/* Mode */}
            <div>
              <label className="text-xs font-semibold text-ink-500 uppercase tracking-wider block mb-1.5">Mode</label>
              <div className="grid grid-cols-2 gap-2">
                <button onClick={() => setExamMode(false)}
                  className={`p-3 rounded-xl border-2 text-left transition-all ${!examMode ? 'border-brand bg-brand-pale' : 'border-ink-200 hover:border-ink-300'}`}>
                  <div className="font-semibold text-sm">ğŸ“ Training</div>
                  <div className="text-xs text-ink-500 mt-0.5">Hints + explanations</div>
                </button>
                <button onClick={() => setExamMode(true)}
                  className={`p-3 rounded-xl border-2 text-left transition-all ${examMode ? 'border-red-400 bg-red-50' : 'border-ink-200 hover:border-ink-300'}`}>
                  <div className="font-semibold text-sm">ğŸ† Exam</div>
                  <div className="text-xs text-ink-500 mt-0.5">Timer Â· No hints</div>
                </button>
              </div>
            </div>
          </div>

          {weakTypes.length > 0 && (
            <div className="mt-4 p-3 bg-amber-50 border border-amber-200 rounded-xl">
              <div className="text-xs font-semibold text-amber-800 mb-1.5">âš ï¸ AI will target your weak areas:</div>
              <div className="flex flex-wrap gap-1.5">
                {weakTypes.map(t => <span key={t} className="bg-amber-100 text-amber-800 text-xs px-2 py-0.5 rounded-full border border-amber-300 font-medium">{t}</span>)}
              </div>
            </div>
          )}
        </div>

        {/* Q-type accuracy (if any) */}
        {Object.keys(stats.byQType).length > 0 && (
          <div className="bg-white rounded-2xl p-5 shadow-sm border border-ink-200">
            <div className="font-semibold text-ink-800 mb-3 text-sm">Question Type Accuracy</div>
            <div className="space-y-2.5">
              {Object.entries(stats.byQType).map(([type, data]) => {
                const pct = Math.round((data.correct/data.total)*100);
                const barColor = pct >= 80 ? 'bg-good' : pct >= 60 ? 'bg-warn' : 'bg-bad';
                return (
                  <div key={type}>
                    <div className="flex justify-between text-xs mb-1">
                      <span className="text-ink-600">{type}</span>
                      <span className={`font-bold ${pct>=80?'text-good':pct>=60?'text-warn':'text-bad'}`}>{pct}%</span>
                    </div>
                    <div className="h-1.5 bg-ink-100 rounded-full overflow-hidden">
                      <div className={`h-full ${barColor} rounded-full transition-all`} style={{width:`${pct}%`}}></div>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        )}

      </div>

      {/* Sticky CTA */}
      <div className="sticky bottom-0 bg-white border-t border-ink-200 px-4 pt-3 pb-4 safe-bottom">
        <button onClick={handleStart} disabled={!localKey.trim()}
          className={`w-full py-4 rounded-2xl font-bold text-base transition-all shadow-lg ${localKey.trim() ? 'bg-brand text-white hover:bg-brand-light active:scale-[.98]' : 'bg-ink-200 text-ink-400 cursor-not-allowed'}`}>
          {localKey.trim() ? 'âœ¦ Generate Passage & Start' : 'ğŸ”‘ Enter API Key to Start'}
        </button>
      </div>
    </div>
  );
}

// â”€â”€â”€ LOADING SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function LoadingScreen({ passageType, difficulty }) {
  const [step, setStep] = useState(0);
  const steps = [
    'Connecting to Gemini AIâ€¦',
    'Crafting a CUET-style passageâ€¦',
    'Writing expert questionsâ€¦',
    'Calibrating traps & distractorsâ€¦',
    'Preparing your examâ€¦'
  ];
  useEffect(() => {
    const t = setInterval(() => setStep(s => Math.min(s+1, steps.length-1)), 900);
    return () => clearInterval(t);
  }, []);

  return (
    <div className="min-h-screen bg-brand-dark flex flex-col items-center justify-center text-white p-8">
      <div className="text-6xl mb-8 animate-bounce">ğŸ§ </div>
      <div className="font-serif text-2xl mb-1">Generating Passage</div>
      <div className="text-brand-accent text-sm mb-8">{passageType} Â· {difficulty}</div>
      <div className="w-56 h-1.5 bg-white/20 rounded-full overflow-hidden mb-8">
        <div className="h-full bg-brand-accent rounded-full transition-all duration-700" style={{width:`${((step+1)/steps.length)*100}%`}}></div>
      </div>
      <div className="space-y-3 text-sm">
        {steps.map((s, i) => (
          <div key={i} className={`flex items-center gap-3 transition-all duration-300 ${i <= step ? 'text-white' : 'text-white/25'}`}>
            <span className="text-base w-5 text-center">{i < step ? 'âœ…' : i === step ? 'â³' : 'â—‹'}</span>
            {s}
          </div>
        ))}
      </div>
    </div>
  );
}

// â”€â”€â”€ EXAM SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ExamScreen({ passageData, examMode, onFinish, onHome }) {
  const [currentQ, setCurrentQ] = useState(0);
  const [selections, setSelections] = useState({});
  const [statuses, setStatuses] = useState({});
  const [submitted, setSubmitted] = useState(false);
  const [showHint, setShowHint] = useState(false);
  const [showExplanation, setShowExplanation] = useState({});
  const [mobileTab, setMobileTab] = useState('passage'); // 'passage' | 'question' | 'palette'
  const questionPanelRef = useRef(null);

  const timerSecs = examMode ? 8*60 : 999999;
  const { left, formatted, pct } = useTimer(timerSecs, !submitted);
  const totalQ = passageData.questions.length;
  const q = passageData.questions[currentQ];

  // Auto-submit on timer end
  useEffect(() => { if (left === 0 && !submitted) handleSubmit(); }, [left]);

  // Scroll question panel to top when changing question
  useEffect(() => {
    if (questionPanelRef.current) questionPanelRef.current.scrollTop = 0;
    setShowHint(false);
  }, [currentQ]);

  const getStatus = i => statuses[i] || 'not-visited';

  const selectOption = (optIdx) => {
    if (submitted) return;
    setSelections(prev => ({ ...prev, [currentQ]: optIdx }));
    setStatuses(prev => ({
      ...prev,
      [currentQ]: (prev[currentQ]==='marked'||prev[currentQ]==='answered-marked') ? 'answered-marked' : 'answered'
    }));
    if (!examMode) {
      setShowExplanation(prev => ({ ...prev, [currentQ]: true }));
      setMobileTab('question'); // keep on question after selecting
    }
  };

  const markForReview = () => {
    if (submitted) return;
    setStatuses(prev => {
      const cur = prev[currentQ];
      if (cur==='answered'||cur==='answered-marked') return { ...prev, [currentQ]:'answered-marked' };
      return { ...prev, [currentQ]:'marked' };
    });
    goNext();
  };

  const clearResponse = () => {
    if (submitted) return;
    setSelections(prev => { const n={...prev}; delete n[currentQ]; return n; });
    setStatuses(prev => { const n={...prev}; n[currentQ]='not-answered'; return n; });
    setShowExplanation(prev => { const n={...prev}; delete n[currentQ]; return n; });
  };

  const goNext = () => {
    if (currentQ < totalQ-1) {
      if (!statuses[currentQ]) setStatuses(prev => ({ ...prev, [currentQ]:'not-answered' }));
      setCurrentQ(currentQ+1);
      setMobileTab('question');
    }
  };

  const goPrev = () => {
    if (currentQ > 0) { setCurrentQ(currentQ-1); setMobileTab('question'); }
  };

  const saveAndNext = () => {
    if (selections[currentQ]===undefined) setStatuses(prev => ({ ...prev, [currentQ]:'not-answered' }));
    goNext();
  };

  const handleSubmit = () => {
    const ns = { ...statuses };
    for (let i=0; i<totalQ; i++) if (!ns[i]) ns[i]='not-answered';
    setStatuses(ns);
    setSubmitted(true);
    const ae = {};
    for (let i=0; i<totalQ; i++) ae[i]=true;
    setShowExplanation(ae);
    setCurrentQ(0);
    setMobileTab('question');
  };

  const buildResults = () => ({
    stats: passageData.questions.map((q,i) => ({
      qType: q.qType,
      passageType: passageData.passageType,
      correct: selections[i]===q.correctIndex
    })),
    selections: { ...selections }
  });

  const palClass = (i) => {
    const s = getStatus(i);
    let cls = 'qs';
    if (s==='answered') cls += ' qs-answered';
    else if (s==='not-answered') cls += ' qs-not-answered';
    else if (s==='marked') cls += ' qs-marked';
    else if (s==='answered-marked') cls += ' qs-answered-marked';
    else cls += ' qs-not-visited';
    if (i===currentQ) cls += ' qs-current';
    return cls;
  };

  const isCorrect = selections[currentQ]===q.correctIndex;
  const isAnswered = selections[currentQ]!==undefined;
  const showReveal = submitted || (!examMode && isAnswered);
  const timerDanger = examMode && left < 120;

  // Summary counts
  const answeredCount = Object.values(statuses).filter(s=>s==='answered'||s==='answered-marked').length;
  const notAnsweredCount = Object.values(statuses).filter(s=>s==='not-answered').length;
  const markedCount = Object.values(statuses).filter(s=>s==='marked'||s==='answered-marked').length;

  // â”€â”€ PASSAGE PANEL (inline JSX â€” NOT a sub-component, avoids remount on every render) â”€â”€
  const passageJSX = (
    <div key="passage" className="scroll-panel flex-1 bg-white p-5">
      <div className="inline-block bg-brand-pale text-brand text-xs font-semibold px-3 py-1 rounded-full mb-4">ğŸ“– Reading Passage</div>
      <h2 className="font-serif text-xl text-ink-900 mb-5 leading-snug">{passageData.title}</h2>
      {passageData.passage.split('\n\n').map((para,i) => (
        <p key={i} className="text-ink-800 text-base leading-[1.9] mb-5" style={{textAlign:'justify'}}>{para}</p>
      ))}
      {showReveal && q.keyLine && (
        <div className="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-xl slide-up">
          <div className="text-sm font-bold text-yellow-800 mb-1.5">ğŸ” Key Evidence:</div>
          <p className="text-sm text-yellow-900 italic leading-relaxed">"{q.keyLine}"</p>
        </div>
      )}
      {/* bottom padding so last paragraph isn't flush against tab bar */}
      <div className="h-6" />
    </div>
  );

  // â”€â”€ QUESTION PANEL (inline JSX) â”€â”€
  const questionJSX = (
    <div key="question" ref={questionPanelRef} className="scroll-panel flex-1 bg-ink-50 p-4 md:p-5">
      {/* Question header */}
      <div className="flex items-center justify-between mb-3">
        <div className="flex items-center gap-2 flex-wrap">
          <span className="bg-brand text-white text-sm font-bold px-3 py-1 rounded-lg">Q {currentQ+1}/{totalQ}</span>
          <QTypeBadge type={q.qType} />
        </div>
        <span className="text-sm text-ink-400 font-mono">+5 / âˆ’1</span>
      </div>

      {/* Question text */}
      <div className="bg-white border border-ink-200 rounded-2xl p-4 mb-4 shadow-sm">
        <p className="text-ink-900 text-base leading-relaxed font-medium">{q.question}</p>
      </div>

      {/* Options */}
      <div className="space-y-3 mb-4">
        {q.options.map((opt, oi) => {
          const isSel = selections[currentQ]===oi;
          const isCorr = oi===q.correctIndex;
          let cls = 'opt-default';
          if (showReveal) {
            if (isCorr) cls = 'opt-correct';
            else if (isSel && !isCorr) cls = 'opt-wrong';
            else cls = 'border-2 border-ink-100 bg-white opacity-50';
          } else if (isSel) {
            cls = 'opt-selected';
          }
          return (
            <button key={oi} onClick={() => selectOption(oi)}
              disabled={submitted && examMode}
              className={`w-full flex items-start gap-3 p-4 rounded-2xl text-left transition-all active:scale-[.98] ${cls}`}>
              <div className={`w-8 h-8 rounded-full border-2 flex items-center justify-center text-sm font-bold flex-shrink-0 mt-0.5 transition-all ${
                showReveal && isCorr ? 'bg-good border-good text-white' :
                showReveal && isSel && !isCorr ? 'bg-bad border-bad text-white' :
                isSel ? 'bg-brand border-brand text-white' :
                'bg-white border-ink-300 text-ink-500'
              }`}>{String.fromCharCode(65+oi)}</div>
              <span className="text-base text-ink-800 leading-relaxed flex-1">{opt}</span>
              {showReveal && isCorr && <span className="text-good text-xl flex-shrink-0">âœ“</span>}
              {showReveal && isSel && !isCorr && <span className="text-bad text-xl flex-shrink-0">âœ—</span>}
            </button>
          );
        })}
      </div>

      {/* Hint */}
      {!examMode && !submitted && !isAnswered && (
        <div className="mb-4">
          <button onClick={() => setShowHint(p=>!p)} className="text-sm text-brand font-semibold hover:underline">
            {showHint ? 'â–² Hide hint' : 'ğŸ’¡ Show strategy hint'}
          </button>
          {showHint && (
            <div className="mt-2 p-4 bg-amber-50 border border-amber-200 rounded-xl slide-up">
              <div className="text-sm font-bold text-amber-800 mb-1">Strategy hint:</div>
              <p className="text-sm text-amber-900 leading-relaxed">{q.hint}</p>
            </div>
          )}
        </div>
      )}

      {/* Explanation */}
      {showReveal && showExplanation[currentQ] && (
        <div className="space-y-3 slide-up">
          <div className={`flex items-center gap-2 p-3.5 rounded-xl font-semibold text-base ${
            isAnswered ? (isCorrect ? 'bg-green-50 text-good border border-green-200' : 'bg-red-50 text-bad border border-red-200') : 'bg-ink-100 text-ink-600 border border-ink-200'
          }`}>
            {isAnswered ? (isCorrect ? 'âœ… Correct â€” +5 marks' : 'âŒ Wrong â€” âˆ’1 mark') : 'âšª Not attempted'}
          </div>
          <div className="bg-brand-pale border border-blue-200 rounded-xl p-4">
            <div className="text-sm font-bold text-brand mb-2">ğŸ“ Expert Explanation</div>
            <p className="text-sm text-ink-800 leading-relaxed">{q.explanation}</p>
          </div>
          {q.trapType && q.trapType!=='None' && (
            <div className="bg-orange-50 border border-orange-200 rounded-xl p-4">
              <div className="text-sm font-bold text-orange-800 mb-1.5">ğŸª¤ Trap: {q.trapType}</div>
              <p className="text-sm text-orange-700 leading-relaxed">{getTrapExplanation(q.trapType)}</p>
            </div>
          )}
          <div className="bg-purple-50 border border-purple-200 rounded-xl p-4">
            <div className="text-sm font-bold text-purple-800 mb-1.5">ğŸ“ {q.qType} Strategy</div>
            <p className="text-sm text-purple-900 leading-relaxed">{getQTypeStrategy(q.qType)}</p>
          </div>
        </div>
      )}

      {/* Action buttons */}
      <div className="mt-5 pt-4 border-t border-ink-200">
        {!submitted ? (
          <div className="flex gap-2">
            <button onClick={markForReview}
              className="flex-1 bg-review text-white text-sm font-semibold py-3.5 px-3 rounded-xl transition-all hover:opacity-90 active:scale-[.98]">
              ğŸ”– Mark & Next
            </button>
            <button onClick={clearResponse}
              className="bg-ink-200 text-ink-700 text-sm font-semibold py-3.5 px-4 rounded-xl transition-all hover:bg-ink-300 active:scale-[.98]">
              Clear
            </button>
            <button onClick={saveAndNext}
              className="flex-1 bg-brand text-white text-sm font-bold py-3.5 px-3 rounded-xl transition-all hover:bg-brand-light active:scale-[.98]">
              Save & Next â†’
            </button>
          </div>
        ) : (
          <div className="flex gap-2">
            <button onClick={goPrev} disabled={currentQ===0}
              className="bg-ink-200 text-ink-700 text-sm font-semibold py-3.5 px-4 rounded-xl disabled:opacity-40">
              â† Prev
            </button>
            <button onClick={() => onFinish(buildResults())}
              className="flex-1 bg-good text-white text-sm font-bold py-3.5 rounded-xl hover:opacity-90 active:scale-[.98]">
              See Results â†’
            </button>
            <button onClick={goNext} disabled={currentQ===totalQ-1}
              className="bg-ink-200 text-ink-700 text-sm font-semibold py-3.5 px-4 rounded-xl disabled:opacity-40">
              Next â†’
            </button>
          </div>
        )}
      </div>
      <div className="h-6" />
    </div>
  );

  // â”€â”€ PALETTE PANEL (inline JSX) â”€â”€
  const paletteJSX = (
    <div key="palette" className="scroll-panel flex-1 bg-white p-4">
      <div className="text-xs font-bold text-ink-500 uppercase tracking-wider mb-3">Question Palette</div>
      <div className="grid grid-cols-5 gap-2 mb-5">
        {passageData.questions.map((_,i) => (
          <button key={i} className={palClass(i)} onClick={() => { setCurrentQ(i); setMobileTab('question'); }}>
            {i+1}
          </button>
        ))}
      </div>
      <div className="space-y-2 mb-5">
        {[
          { cls:'qs-answered', label:'Answered' },
          { cls:'qs-not-answered', label:'Not Answered' },
          { cls:'qs-marked', label:'Marked for Review' },
          { cls:'qs-not-visited', label:'Not Visited' },
        ].map(({cls,label}) => (
          <div key={label} className="flex items-center gap-2.5">
            <div className={`qs ${cls}`} style={{width:28,height:28,fontSize:12}}>1</div>
            <span className="text-sm text-ink-600">{label}</span>
          </div>
        ))}
      </div>
      <div className="bg-ink-50 rounded-xl p-3.5 space-y-2 text-sm mb-5">
        <div className="flex justify-between"><span className="text-ink-500">Answered</span><span className="font-bold text-good">{answeredCount}</span></div>
        <div className="flex justify-between"><span className="text-ink-500">Not Answered</span><span className="font-bold text-bad">{notAnsweredCount}</span></div>
        <div className="flex justify-between"><span className="text-ink-500">Marked</span><span className="font-bold text-review">{markedCount}</span></div>
        <div className="flex justify-between"><span className="text-ink-500">Not Visited</span><span className="font-bold text-ink-400">{totalQ - Object.keys(statuses).length}</span></div>
      </div>
      {!submitted ? (
        <button onClick={handleSubmit} className="w-full bg-bad text-white text-base font-bold py-4 rounded-xl hover:opacity-90 active:scale-[.98]">
          Submit Test
        </button>
      ) : (
        <button onClick={() => onFinish(buildResults())} className="w-full bg-good text-white text-base font-bold py-4 rounded-xl hover:opacity-90 active:scale-[.98]">
          See Results â†’
        </button>
      )}
      <div className="h-4" />
    </div>
  );

  return (
    <div className="exam-root flex flex-col bg-ink-100">

      {/* â”€â”€ TOP BAR â”€â”€ */}
      <div className="bg-brand-dark text-white flex-shrink-0">
        <div className="px-3 py-2.5 flex items-center gap-2">
          <button onClick={onHome} className="text-xs border border-white/30 text-white/80 hover:text-white px-2.5 py-1.5 rounded-lg font-medium transition-colors flex-shrink-0">
            â† Home
          </button>
          <div className="flex-1 min-w-0">
            <div className="text-xs text-brand-accent truncate">{passageData.passageType} Â· {passageData.difficulty}</div>
          </div>
          {examMode && (
            <div className={`font-mono text-sm font-bold px-3 py-1.5 rounded-lg flex-shrink-0 ${timerDanger ? 'bg-red-600 pulse-red' : 'bg-white/10'}`}>
              â± {formatted}
            </div>
          )}
          {!examMode && <span className="text-xs text-brand-accent bg-white/10 px-2 py-1 rounded-lg flex-shrink-0">Training</span>}
          {!submitted ? (
            <button onClick={handleSubmit}
              className="bg-bad hover:opacity-90 text-white text-xs px-3 py-1.5 rounded-lg font-bold flex-shrink-0">
              Submit
            </button>
          ) : (
            <button onClick={() => onFinish(buildResults())}
              className="bg-good hover:opacity-90 text-white text-xs px-3 py-1.5 rounded-lg font-bold flex-shrink-0 whitespace-nowrap">
              Results â†’
            </button>
          )}
        </div>
      </div>

      {/* â”€â”€ DESKTOP LAYOUT (lg+): 3 columns â”€â”€ */}
      <div className="hidden lg:flex flex-1 overflow-hidden" style={{minHeight:0}}>
        {/* Passage */}
        <div className="w-5/12 border-r border-ink-200 flex-shrink-0 flex flex-col" style={{minHeight:0}}>
          {passageJSX}
        </div>
        {/* Questions */}
        <div className="flex-1 flex flex-col" style={{minHeight:0}}>
          {questionJSX}
        </div>
        {/* Palette sidebar */}
        <div className="w-52 border-l border-ink-200 flex-shrink-0 flex flex-col" style={{minHeight:0}}>
          {paletteJSX}
        </div>
      </div>

      {/* â”€â”€ MOBILE LAYOUT: 3-tab â”€â”€ */}
      <div className="lg:hidden flex flex-col flex-1" style={{minHeight:0}}>
        {/* Tab content area â€” takes all remaining space, child scrolls */}
        <div className="flex-1 flex flex-col" style={{minHeight:0}}>
          {mobileTab==='passage'  && passageJSX}
          {mobileTab==='question' && questionJSX}
          {mobileTab==='palette'  && paletteJSX}
        </div>

        {/* Bottom tab bar â€” always visible, never scrolls away */}
        <div className="tab-bar flex">
          {[
            { key:'passage',  label:'Passage',  icon:'ğŸ“–' },
            { key:'question', label:'Question', icon:'âœï¸' },
            { key:'palette',  label:'Palette',  icon:'ğŸ—‚ï¸', badge: `${answeredCount}/${totalQ}` },
          ].map(tab => (
            <button
              key={tab.key}
              onClick={() => setMobileTab(tab.key)}
              className={`tab-btn${mobileTab===tab.key ? ' tab-active' : ''}`}>
              <span style={{fontSize:22, lineHeight:1}}>{tab.icon}</span>
              <span style={{fontSize:11, fontWeight:600, marginTop:3}}>{tab.label}</span>
              {tab.badge && <span style={{fontSize:10, fontWeight:700, marginTop:1, color: mobileTab===tab.key ? '#1d4ed8' : '#94a3b8'}}>{tab.badge}</span>}
            </button>
          ))}
        </div>
      </div>

    </div>
  );
}

// â”€â”€â”€ RESULTS SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ResultsScreen({ passageData, selections, stats, onHome, onRetry }) {
  const results = passageData.questions.map((q,i) => ({
    q, i,
    selected: selections[i],
    correct: selections[i]===q.correctIndex,
    attempted: selections[i]!==undefined
  }));

  const correct = results.filter(r=>r.correct).length;
  const wrong = results.filter(r=>r.attempted&&!r.correct).length;
  const notAttempted = results.filter(r=>!r.attempted).length;
  const marks = correct*5 + wrong*(-1);
  const maxMarks = passageData.questions.length*5;
  const pct = Math.round((correct/passageData.questions.length)*100);
  const uniqueWeakTypes = [...new Set(results.filter(r=>!r.correct).map(r=>r.q.qType))];

  const grade = pct===100 ? { emoji:'ğŸ†', label:'Perfect Score!', color:'text-good', bg:'bg-green-50', border:'border-green-200' }
    : pct>=83 ? { emoji:'â­', label:'Excellent', color:'text-brand', bg:'bg-blue-50', border:'border-blue-200' }
    : pct>=67 ? { emoji:'ğŸ“ˆ', label:'Good Work', color:'text-warn', bg:'bg-amber-50', border:'border-amber-200' }
    : { emoji:'ğŸ’ª', label:'Keep Practicing', color:'text-bad', bg:'bg-red-50', border:'border-red-200' };

  return (
    <div className="min-h-screen bg-ink-100">
      <div className="bg-brand-dark text-white px-4 py-3.5 flex items-center justify-between">
        <div className="font-serif text-lg">Results & Analysis</div>
        <div className="flex gap-2">
          <button onClick={onRetry} className="bg-white/15 hover:bg-white/25 text-white text-xs px-3 py-1.5 rounded-lg font-medium">ğŸ”„ New</button>
          <button onClick={onHome} className="bg-white/15 hover:bg-white/25 text-white text-xs px-3 py-1.5 rounded-lg font-medium">ğŸ  Home</button>
        </div>
      </div>

      <div className="max-w-2xl mx-auto px-4 py-5 space-y-4">

        {/* Score card */}
        <div className={`${grade.bg} border-2 ${grade.border} rounded-2xl p-6 text-center fade-in`}>
          <div className="text-5xl mb-2">{grade.emoji}</div>
          <div className={`text-xl font-bold ${grade.color} mb-1`}>{grade.label}</div>
          <div className="text-5xl font-serif font-bold text-ink-900 my-3">{marks} <span className="text-2xl text-ink-400">/ {maxMarks}</span></div>
          <div className="text-sm text-ink-500">{pct}% accuracy Â· {passageData.difficulty}</div>
          <div className="grid grid-cols-3 gap-2.5 mt-5">
            <div className="bg-white rounded-2xl p-3 border border-green-200">
              <div className="text-2xl font-bold text-good">{correct}</div>
              <div className="text-xs text-ink-400">Correct (+{correct*5})</div>
            </div>
            <div className="bg-white rounded-2xl p-3 border border-red-200">
              <div className="text-2xl font-bold text-bad">{wrong}</div>
              <div className="text-xs text-ink-400">Wrong ({wrong>0?'-'+wrong:0})</div>
            </div>
            <div className="bg-white rounded-2xl p-3 border border-ink-200">
              <div className="text-2xl font-bold text-ink-400">{notAttempted}</div>
              <div className="text-xs text-ink-400">Skipped</div>
            </div>
          </div>
        </div>

        {/* Weak areas */}
        {uniqueWeakTypes.length > 0 && (
          <div className="bg-white rounded-2xl p-5 border border-orange-200 fade-in">
            <h3 className="font-semibold text-ink-800 mb-3">ğŸ¯ Areas to Improve</h3>
            <div className="space-y-3">
              {uniqueWeakTypes.map(type => (
                <div key={type} className="p-3.5 bg-orange-50 border border-orange-100 rounded-xl">
                  <div className="font-semibold text-orange-800 text-sm mb-1.5">âŒ {type}</div>
                  <p className="text-xs text-orange-700 leading-relaxed">{getQTypeStrategy(type)}</p>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Q-by-Q review */}
        <div className="bg-white rounded-2xl p-5 border border-ink-200 fade-in">
          <h3 className="font-semibold text-ink-800 mb-4">ğŸ“‹ Question Review</h3>
          <div className="space-y-4">
            {results.map(({ q, i, selected, correct: isCorr, attempted }) => (
              <div key={i} className={`border-2 rounded-2xl p-4 ${isCorr?'border-green-200 bg-green-50':attempted?'border-red-200 bg-red-50':'border-ink-200 bg-ink-50'}`}>
                <div className="flex items-center justify-between mb-2 flex-wrap gap-1">
                  <div className="flex items-center gap-2">
                    <span className="text-base">{isCorr?'âœ…':attempted?'âŒ':'âšª'}</span>
                    <span className="font-semibold text-sm">Q{i+1}</span>
                    <QTypeBadge type={q.qType} />
                  </div>
                  {q.trapType && q.trapType!=='None' && (
                    <span className="text-xs bg-orange-100 text-orange-700 border border-orange-200 px-2 py-0.5 rounded-full font-medium">{q.trapType}</span>
                  )}
                </div>
                <p className="text-xs text-ink-700 mb-3 leading-relaxed">{q.question}</p>
                <div className="space-y-1.5 mb-3">
                  {q.options.map((opt,oi) => (
                    <div key={oi} className={`text-xs p-2 rounded-lg flex items-start gap-2 ${
                      oi===q.correctIndex ? 'bg-green-100 text-green-800 font-semibold border border-green-300' :
                      oi===selected&&!isCorr ? 'bg-red-100 text-red-700 border border-red-300' :
                      'bg-white text-ink-600 border border-ink-100'
                    }`}>
                      <span className="font-bold flex-shrink-0">{String.fromCharCode(65+oi)}.</span>
                      <span>{opt}</span>
                    </div>
                  ))}
                </div>
                <div className="bg-white/70 border border-blue-100 rounded-xl p-3">
                  <div className="text-xs font-bold text-brand mb-1">ğŸ’¡ Explanation:</div>
                  <p className="text-xs text-ink-700 leading-relaxed">{q.explanation}</p>
                </div>
              </div>
            ))}
          </div>
        </div>

        {/* Actions */}
        <div className="grid grid-cols-2 gap-3 pb-8">
          <button onClick={onRetry} className="bg-brand text-white font-bold py-4 rounded-2xl hover:bg-brand-light transition-colors shadow-lg">
            ğŸ”„ New Passage
          </button>
          <button onClick={onHome} className="bg-white text-brand font-bold py-4 rounded-2xl border-2 border-brand hover:bg-brand-pale transition-colors">
            ğŸ  Dashboard
          </button>
        </div>
      </div>
    </div>
  );
}

// â”€â”€â”€ ROOT APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function App() {
  const [apiKey, setApiKey] = useState(() => {
    try { return localStorage.getItem(API_KEY_STORAGE) || ''; } catch(e) { return ''; }
  });
  const [stats, setStats] = useState(() => loadStats());
  const [screen, setScreen] = useState('home');
  const [sessionConfig, setSessionConfig] = useState(null);
  const [passageData, setPassageData] = useState(null);
  const [error, setError] = useState(null);
  const [selections, setSelections] = useState({});

  const handleStart = async (config) => {
    setSessionConfig(config);
    setError(null);
    setScreen('loading');
    try {
      const weakTypes = getWeakQTypes(stats);
      const data = await generateRCPassage(apiKey, config.passageType, config.difficulty, weakTypes);
      setPassageData(data);
      setSelections({});
      setScreen('exam');
    } catch(e) {
      setError(e.message);
      setScreen('home');
    }
  };

  return (
    <div>
      {error && (
        <div className="fixed top-4 left-1/2 -translate-x-1/2 z-50 bg-bad text-white px-5 py-3.5 rounded-2xl shadow-2xl text-sm font-medium max-w-xs text-center slide-up">
          âŒ {error}
          <button onClick={() => setError(null)} className="ml-3 underline text-white/80 hover:text-white">Dismiss</button>
        </div>
      )}

      {screen==='home' && <SetupScreen apiKey={apiKey} setApiKey={setApiKey} stats={stats} onStart={handleStart} />}
      {screen==='loading' && sessionConfig && <LoadingScreen passageType={sessionConfig.passageType} difficulty={sessionConfig.difficulty} />}
      {screen==='exam' && passageData && (
        <ExamScreen
          passageData={passageData}
          examMode={sessionConfig?.examMode}
          stats={stats}
          onFinish={(payload) => {
            const results = payload.stats||payload;
            const sel = payload.selections||{};
            const newStats = updateStats(stats, results);
            setStats(newStats);
            saveStats(newStats);
            setSelections(sel);
            setScreen('results');
          }}
          onHome={() => setScreen('home')}
        />
      )}
      {screen==='results' && passageData && (
        <ResultsScreen
          passageData={passageData}
          selections={selections}
          stats={stats}
          onHome={() => setScreen('home')}
          onRetry={() => handleStart(sessionConfig)}
        />
      )}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
